# 管理者画面設計

## 概要

管理者がシステム全体を監視・管理するためのWebベースの管理画面の設計ドキュメント。

## 目的

- システム全体の健全性を監視
- ユーザー管理（管理者権限付与など）
- データベースメンテナンス操作
- 統計情報の可視化

## アクセス制御

### 認証・認可

- **認証**: 既存のJWT Cookie認証を使用
- **認可**: `users.is_admin` フラグによる管理者権限チェック
- **実装場所**:
  - バックエンド: `app.api.deps.get_admin_user()`
  - フロントエンド: Vue Routerのナビゲーションガード

### セキュリティ要件

- すべての管理者APIエンドポイントで管理者権限チェック必須
- 破壊的操作（削除、一括更新など）には確認ダイアログ必須
- 操作ログの記録（将来的な拡張）

---

## フェーズ1: ユーザー管理

### 機能要件

#### 1.1 ユーザー一覧表示

**表示項目:**
- ID
- ユーザー名
- メールアドレス（配信者モード対応でマスク可能）
- 管理者フラグ（アイコン表示）
- 登録日
- 最終ログイン日（将来的な拡張）

**機能:**
- ページネーション（20件/ページ）
- ソート（ID、登録日、ユーザー名）
- 検索（ユーザー名、メール）
- フィルタ（管理者のみ表示）

#### 1.2 管理者権限の付与/削除

**操作:**
- ユーザー一覧から個別に管理者フラグをトグル
- 確認ダイアログ表示（「{username}を管理者にしますか？」）
- 自分自身の管理者権限は削除不可（エラー表示）

**制約:**
- 最低1人の管理者が必要（最後の管理者は削除不可）

### API設計

#### GET /admin/users

**レスポンス:**
```json
{
  "users": [
    {
      "id": 1,
      "username": "user1",
      "email": "user1@example.com",
      "is_admin": true,
      "createdat": "2025-01-01T00:00:00Z"
    }
  ],
  "total": 100,
  "page": 1,
  "per_page": 20
}
```

**クエリパラメータ:**
- `page`: ページ番号（デフォルト: 1）
- `per_page`: 1ページあたりの件数（デフォルト: 20、最大: 100）
- `sort`: ソート項目（`id`, `username`, `createdat`）
- `order`: ソート順（`asc`, `desc`）
- `search`: 検索クエリ（ユーザー名、メール）
- `admin_only`: 管理者のみ表示（`true`/`false`）

#### PUT /admin/users/{user_id}/admin-status

**リクエスト:**
```json
{
  "is_admin": true
}
```

**レスポンス:**
```json
{
  "success": true,
  "user": {
    "id": 1,
    "username": "user1",
    "is_admin": true
  }
}
```

**エラーケース:**
- 自分自身の権限削除: 403 Forbidden
- 最後の管理者の権限削除: 400 Bad Request

### UI設計

#### コンポーネント構成

```
AdminView.vue
├── UserManagementSection.vue
│   ├── UserTable.vue
│   │   ├── UserRow.vue
│   │   │   └── AdminToggleButton.vue
│   │   └── Pagination.vue
│   ├── UserSearchBar.vue
│   └── UserFilters.vue
└── ConfirmAdminChangeDialog.vue
```

#### レイアウト

```
┌─────────────────────────────────────────────┐
│ 管理者画面                                   │
├─────────────────────────────────────────────┤
│ [ユーザー管理] [統計] [メンテナンス]          │
├─────────────────────────────────────────────┤
│ ユーザー管理                                 │
│                                             │
│ [検索: ___________] [管理者のみ ☐]           │
│                                             │
│ ┌───┬──────┬─────────┬────┬──────┬────┐  │
│ │ID │ユーザー│メール    │管理者│登録日 │操作│  │
│ ├───┼──────┼─────────┼────┼──────┼────┤  │
│ │ 1 │user1  │u1@..    │👑  │2025-01│変更│  │
│ │ 2 │user2  │u2@..    │    │2025-01│変更│  │
│ └───┴──────┴─────────┴────┴──────┴────┘  │
│                                             │
│ ページ: [< 1 2 3 >]                         │
└─────────────────────────────────────────────┘
```

---

## フェーズ2: システム統計ダッシュボード

### 機能要件

#### 2.1 統計カード表示

**表示項目:**

1. **総ユーザー数**
   - 全ユーザー数
   - 先月比（+5%など）

2. **総デッキ数**
   - アクティブデッキ数
   - アーカイブデッキ数
   - プレイヤーデッキ vs 相手デッキの比率

3. **総対戦数**
   - 全期間の対戦数
   - 今月の対戦数
   - ゲームモード別内訳（RANK/RATE/EVENT/DC）

4. **今月のアクティブユーザー数**
   - 今月対戦記録を追加したユーザー数
   - 先月比

#### 2.2 グラフ表示

**対戦数の推移（折れ線グラフ）:**
- 直近30日間の日別対戦数
- Chart.jsまたはVuetifyのチャートコンポーネント使用

**ゲームモード別対戦数（円グラフ）:**
- RANK、RATE、EVENT、DCの割合

**ユーザー登録数の推移（棒グラフ）:**
- 月別の新規ユーザー数（直近12ヶ月）

### API設計

#### GET /admin/statistics/overview

**レスポンス:**
```json
{
  "users": {
    "total": 1523,
    "new_this_month": 45,
    "active_this_month": 234
  },
  "decks": {
    "active": 3245,
    "archived": 891,
    "player_decks": 1823,
    "opponent_decks": 2313
  },
  "duels": {
    "total": 45678,
    "this_month": 2345,
    "by_game_mode": {
      "RANK": 23456,
      "RATE": 15678,
      "EVENT": 4567,
      "DC": 1977
    }
  }
}
```

#### GET /admin/statistics/duels-timeline

**クエリパラメータ:**
- `period`: `daily` | `monthly`（デフォルト: `daily`）
- `days`: 日数（デフォルト: 30、最大: 365）

**レスポンス:**
```json
{
  "timeline": [
    {
      "date": "2025-01-01",
      "count": 145
    },
    {
      "date": "2025-01-02",
      "count": 167
    }
  ]
}
```

#### GET /admin/statistics/user-registrations

**クエリパラメータ:**
- `months`: 月数（デフォルト: 12、最大: 24）

**レスポンス:**
```json
{
  "registrations": [
    {
      "month": "2024-02",
      "count": 23
    },
    {
      "month": "2024-03",
      "count": 34
    }
  ]
}
```

### UI設計

```
┌─────────────────────────────────────────────┐
│ システム統計                                 │
├─────────────────────────────────────────────┤
│ ┌─────────┐ ┌─────────┐ ┌─────────┐       │
│ │総ユーザー│ │総デッキ  │ │総対戦数  │       │
│ │  1,523  │ │  4,136  │ │ 45,678  │       │
│ │ +5% ↑   │ │ +12% ↑  │ │ +8% ↑   │       │
│ └─────────┘ └─────────┘ └─────────┘       │
│                                             │
│ 対戦数の推移（直近30日）                     │
│ ┌───────────────────────────────────────┐  │
│ │  📈 [折れ線グラフ]                    │  │
│ └───────────────────────────────────────┘  │
│                                             │
│ ┌──────────────────┐ ┌──────────────────┐ │
│ │ゲームモード別     │ │ユーザー登録数推移│ │
│ │  🥧 [円グラフ]   │ │  📊 [棒グラフ]  │ │
│ └──────────────────┘ └──────────────────┘ │
└─────────────────────────────────────────────┘
```

---

## フェーズ3: データベースメンテナンス

### 機能要件

#### 3.1 アーカイブデッキのマージ（実装済み）

- ✅ 重複するアーカイブ済みデッキを統合
- ✅ 確認ダイアログ付き
- ✅ 実行結果の表示

#### 3.2 孤立データのクリーンアップ（新規）

**対象:**
- 対戦履歴が存在しない相手デッキ
- 論理削除されたユーザーのデータ（将来的な拡張）

**操作:**
- 「孤立データをスキャン」ボタン
- スキャン結果表示（削除候補の件数）
- 「クリーンアップ実行」ボタン（確認ダイアログ付き）
- 実行結果表示

#### 3.3 古いデータの削除（新規）

**対象:**
- X日以前のアーカイブ済みデッキ
- X日以前の対戦履歴（慎重に扱う）

**操作:**
- 日数入力フィールド（デフォルト: 365日）
- 「対象データをプレビュー」ボタン
- プレビュー結果表示（削除対象の件数）
- 「削除実行」ボタン（確認ダイアログ付き）
- 実行結果表示

**警告表示:**
- 「この操作は取り消せません」
- 削除対象のデータ件数を明示

### API設計

#### POST /admin/maintenance/scan-orphaned-data

**レスポンス:**
```json
{
  "orphaned_opponent_decks": 45,
  "total_size_mb": 2.3
}
```

#### POST /admin/maintenance/cleanup-orphaned-data

**レスポンス:**
```json
{
  "success": true,
  "deleted_decks": 45,
  "message": "45個の孤立データを削除しました"
}
```

#### POST /admin/maintenance/preview-old-data

**リクエスト:**
```json
{
  "days": 365,
  "target": "archived_decks"  // or "duels"
}
```

**レスポンス:**
```json
{
  "count": 123,
  "oldest_date": "2024-01-01",
  "estimated_size_mb": 5.6
}
```

#### POST /admin/maintenance/delete-old-data

**リクエスト:**
```json
{
  "days": 365,
  "target": "archived_decks",
  "confirm": true
}
```

**レスポンス:**
```json
{
  "success": true,
  "deleted_count": 123,
  "message": "123件のデータを削除しました"
}
```

### UI設計

```
┌─────────────────────────────────────────────┐
│ データベースメンテナンス                      │
├─────────────────────────────────────────────┤
│ 🗂️ アーカイブデッキのマージ                  │
│ 同名のアーカイブ済みデッキを統合             │
│ [実行] ✅実装済み                            │
├─────────────────────────────────────────────┤
│ 🗑️ 孤立データのクリーンアップ                │
│ 対戦履歴が存在しない相手デッキを削除         │
│ [スキャン] [クリーンアップ実行]              │
│ スキャン結果: 45個の孤立データが見つかりました│
├─────────────────────────────────────────────┤
│ 📅 古いデータの削除                          │
│ [365]日以前のデータを削除                    │
│ 対象: [アーカイブデッキ ▼]                   │
│ [プレビュー] [削除実行]                      │
│ ⚠️ この操作は取り消せません                  │
└─────────────────────────────────────────────┘
```

---

## 技術的考慮事項

### パフォーマンス

- **ユーザー一覧**: ページネーション実装必須
- **統計情報**: キャッシュ機構の検討（Redis使用を検討）
- **大規模データ処理**: バックグラウンドジョブ化を検討（Celery等）

### エラーハンドリング

- すべての管理者操作でトランザクション使用
- エラー時は詳細なログ記録
- ユーザーにわかりやすいエラーメッセージ表示

### 監査ログ（将来的な拡張）

- 管理者操作の記録
- 誰が、いつ、何を実行したか
- 新規テーブル `admin_audit_logs` の追加

---

## 実装順序

1. **フェーズ1: ユーザー管理**（優先度: 高）
   - Week 1: バックエンドAPI実装
   - Week 2: フロントエンドUI実装
   - Week 3: テストと調整

2. **フェーズ2: システム統計**（優先度: 高）
   - Week 4: 統計API実装
   - Week 5: ダッシュボードUI実装
   - Week 6: グラフ表示の実装

3. **フェーズ3: データベースメンテナンス**（優先度: 中）
   - Week 7-8: 孤立データクリーンアップ機能
   - Week 9: 古いデータ削除機能
   - Week 10: テストと最終調整

---

## 参考リンク

- [バックエンドアーキテクチャ](./backend-architecture.md)
- [フロントエンドアーキテクチャ](./frontend-architecture.md)
- [DBスキーマ](./db-schema.md)
- [アーカイブデッキマージ設計](./archive-deck-merge-design.md)
