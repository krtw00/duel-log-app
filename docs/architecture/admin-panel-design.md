# 管理者画面設計

## 概要

管理者がシステム全体を監視・管理するためのWebベースの管理画面の設計ドキュメント。

## 実装状況

| フェーズ | 機能 | 実装状況 | 備考 |
|---------|------|---------|------|
| フェーズ1 | ユーザー管理 | ⚠️ 部分実装 | 一覧・管理者権限は実装済み、詳細ビュー・状態管理・パスワードリセットは未実装 |
| フェーズ2 | システム統計ダッシュボード | ❌ 未実装 | UIのみ「近日公開」表示 |
| フェーズ3 | データベースメンテナンス | ⚠️ 部分実装 | デッキマージのみ実装、孤立データクリーンアップは未実装 |
| フェーズ4 | メタ分析 | ❌ 未実装 | 人気デッキ、勝率分析（将来的に公開機能化の可能性あり） |

**実装済みファイル:**
- `backend/app/api/routers/admin.py` - 管理者API
- `backend/app/api/deps.py` - `get_admin_user()` 依存性
- `frontend/src/views/AdminView.vue` - 管理者画面
- `frontend/src/components/admin/UserManagementSection.vue` - ユーザー管理
- `frontend/src/components/admin/MaintenanceSection.vue` - メンテナンス
- `frontend/src/services/adminApi.ts` - APIクライアント

## 目的

- システム全体の健全性を監視
- ユーザー管理（管理者権限付与など）
- データベースメンテナンス操作
- 統計情報の可視化

## アクセス制御

### 認証・認可

- **認証**: 既存のJWT Cookie認証を使用
- **認可**: `users.is_admin` フラグによる管理者権限チェック
- **実装場所**:
  - バックエンド: `app.api.deps.get_admin_user()`
  - フロントエンド: Vue Routerのナビゲーションガード

### セキュリティ要件

- すべての管理者APIエンドポイントで管理者権限チェック必須
- 破壊的操作（削除、一括更新など）には確認ダイアログ必須
- 操作ログの記録（将来的な拡張）

---

## フェーズ1: ユーザー管理

### 機能要件

#### 1.1 ユーザー一覧表示（✅ 実装済み）

**表示項目:**
- ID
- ユーザー名
- メールアドレス（配信者モード対応でマスク可能）
- 管理者フラグ（アイコン表示）
- 登録日
- 最終ログイン日
- アカウント状態（アクティブ/停止中）
- 対戦数（サマリー）

**機能:**
- ページネーション（20件/ページ）
- ソート（ID、登録日、ユーザー名、最終ログイン、対戦数）
- 検索（ユーザー名、メール）
- フィルタ（管理者のみ、状態別）

#### 1.2 管理者権限の付与/削除（✅ 実装済み）

**操作:**
- ユーザー一覧から個別に管理者フラグをトグル
- 確認ダイアログ表示（「{username}を管理者にしますか？」）
- 自分自身の管理者権限は削除不可（エラー表示）

**制約:**
- 最低1人の管理者が必要（最後の管理者は削除不可）

#### 1.3 ユーザー詳細ビュー（❌ 未実装）

**表示項目:**

| カテゴリ | 項目 |
|---------|------|
| 基本情報 | ユーザー名、メール、登録日、最終ログイン |
| 利用状況 | デッキ数（プレイヤー/相手）、対戦数、勝率 |
| 機能利用 | OBSオーバーレイ利用有無、共有URL数 |
| アカウント | 状態、メール認証状況 |

**操作:**
- ユーザー一覧から「詳細」ボタンでモーダル表示
- 詳細画面から各種管理操作へアクセス

#### 1.4 アカウント状態管理（❌ 未実装）

**状態:**

| 状態 | 説明 | ログイン |
|------|------|---------|
| `active` | 通常利用可能 | 可能 |
| `suspended` | 一時停止中 | 不可 |
| `deleted` | 削除済み（30日間復旧可能） | 不可 |

**操作:**
- アカウント停止: 確認ダイアログ + 理由入力
- アカウント復旧: 停止中 → アクティブに戻す
- 削除済みユーザーの完全削除: 30日経過後に自動、または手動

**用途:**
- 不正利用対策
- ユーザーからの一時停止依頼対応

#### 1.5 パスワードリセット（管理者起動）（❌ 未実装）

**操作:**
- ユーザー詳細画面から「パスワードリセットメール送信」ボタン
- Supabase Authのパスワードリセット機能を利用

**用途:**
- メールが届かないユーザーへのサポート対応

### API設計

#### GET /admin/users

**レスポンス:**
```json
{
  "users": [
    {
      "id": 1,
      "username": "user1",
      "email": "user1@example.com",
      "is_admin": true,
      "createdat": "2025-01-01T00:00:00Z"
    }
  ],
  "total": 100,
  "page": 1,
  "per_page": 20
}
```

**クエリパラメータ:**
- `page`: ページ番号（デフォルト: 1）
- `per_page`: 1ページあたりの件数（デフォルト: 20、最大: 100）
- `sort`: ソート項目（`id`, `username`, `createdat`）
- `order`: ソート順（`asc`, `desc`）
- `search`: 検索クエリ（ユーザー名、メール）
- `admin_only`: 管理者のみ表示（`true`/`false`）

#### PUT /admin/users/{user_id}/admin-status

**リクエスト:**
```json
{
  "is_admin": true
}
```

**レスポンス:**
```json
{
  "success": true,
  "user": {
    "id": 1,
    "username": "user1",
    "is_admin": true
  }
}
```

**エラーケース:**
- 自分自身の権限削除: 403 Forbidden
- 最後の管理者の権限削除: 400 Bad Request

#### GET /admin/users/{user_id}

**レスポンス:**
```json
{
  "id": 1,
  "username": "user1",
  "email": "user1@example.com",
  "is_admin": false,
  "status": "active",
  "created_at": "2025-01-01T00:00:00Z",
  "last_login_at": "2025-01-15T12:34:56Z",
  "email_verified": true,
  "stats": {
    "player_deck_count": 5,
    "opponent_deck_count": 23,
    "duel_count": 156,
    "win_rate": 52.3
  },
  "features": {
    "obs_overlay_enabled": true,
    "shared_url_count": 2
  }
}
```

#### PUT /admin/users/{user_id}/status

**リクエスト:**
```json
{
  "status": "suspended",
  "reason": "ユーザーからの一時停止依頼"
}
```

**レスポンス:**
```json
{
  "success": true,
  "user": {
    "id": 1,
    "username": "user1",
    "status": "suspended"
  }
}
```

**エラーケース:**
- 自分自身の停止: 403 Forbidden
- 無効な状態遷移: 400 Bad Request

#### POST /admin/users/{user_id}/reset-password

**レスポンス:**
```json
{
  "success": true,
  "message": "パスワードリセットメールを送信しました"
}
```

### UI設計

#### コンポーネント構成

```
AdminView.vue
├── UserManagementSection.vue
│   ├── UserTable.vue
│   │   ├── UserRow.vue
│   │   │   └── AdminToggleButton.vue
│   │   └── Pagination.vue
│   ├── UserSearchBar.vue
│   └── UserFilters.vue
└── ConfirmAdminChangeDialog.vue
```

#### レイアウト

```
┌─────────────────────────────────────────────┐
│ 管理者画面                                   │
├─────────────────────────────────────────────┤
│ [ユーザー管理] [統計] [メンテナンス]          │
├─────────────────────────────────────────────┤
│ ユーザー管理                                 │
│                                             │
│ [検索: ___________] [管理者のみ ☐]           │
│                                             │
│ ┌───┬──────┬─────────┬────┬──────┬────┐  │
│ │ID │ユーザー│メール    │管理者│登録日 │操作│  │
│ ├───┼──────┼─────────┼────┼──────┼────┤  │
│ │ 1 │user1  │u1@..    │👑  │2025-01│変更│  │
│ │ 2 │user2  │u2@..    │    │2025-01│変更│  │
│ └───┴──────┴─────────┴────┴──────┴────┘  │
│                                             │
│ ページ: [< 1 2 3 >]                         │
└─────────────────────────────────────────────┘
```

---

## フェーズ2: システム統計ダッシュボード

### 機能要件

#### 2.1 統計カード表示

**表示項目:**

1. **総ユーザー数**
   - 全ユーザー数
   - 先月比（+5%など）

2. **総デッキ数**
   - アクティブデッキ数
   - アーカイブデッキ数
   - プレイヤーデッキ vs 相手デッキの比率

3. **総対戦数**
   - 全期間の対戦数
   - 今月の対戦数
   - ゲームモード別内訳（RANK/RATE/EVENT/DC）

4. **今月のアクティブユーザー数**
   - 今月対戦記録を追加したユーザー数
   - 先月比

#### 2.2 グラフ表示

**対戦数の推移（折れ線グラフ）:**
- 直近30日間の日別対戦数
- Chart.jsまたはVuetifyのチャートコンポーネント使用

**ゲームモード別対戦数（円グラフ）:**
- RANK、RATE、EVENT、DCの割合

**ユーザー登録数の推移（棒グラフ）:**
- 月別の新規ユーザー数（直近12ヶ月）

### API設計

#### GET /admin/statistics/overview

**レスポンス:**
```json
{
  "users": {
    "total": 1523,
    "new_this_month": 45,
    "active_this_month": 234
  },
  "decks": {
    "active": 3245,
    "archived": 891,
    "player_decks": 1823,
    "opponent_decks": 2313
  },
  "duels": {
    "total": 45678,
    "this_month": 2345,
    "by_game_mode": {
      "RANK": 23456,
      "RATE": 15678,
      "EVENT": 4567,
      "DC": 1977
    }
  }
}
```

#### GET /admin/statistics/duels-timeline

**クエリパラメータ:**
- `period`: `daily` | `monthly`（デフォルト: `daily`）
- `days`: 日数（デフォルト: 30、最大: 365）

**レスポンス:**
```json
{
  "timeline": [
    {
      "date": "2025-01-01",
      "count": 145
    },
    {
      "date": "2025-01-02",
      "count": 167
    }
  ]
}
```

#### GET /admin/statistics/user-registrations

**クエリパラメータ:**
- `months`: 月数（デフォルト: 12、最大: 24）

**レスポンス:**
```json
{
  "registrations": [
    {
      "month": "2024-02",
      "count": 23
    },
    {
      "month": "2024-03",
      "count": 34
    }
  ]
}
```

### UI設計

```
┌─────────────────────────────────────────────┐
│ システム統計                                 │
├─────────────────────────────────────────────┤
│ ┌─────────┐ ┌─────────┐ ┌─────────┐       │
│ │総ユーザー│ │総デッキ  │ │総対戦数  │       │
│ │  1,523  │ │  4,136  │ │ 45,678  │       │
│ │ +5% ↑   │ │ +12% ↑  │ │ +8% ↑   │       │
│ └─────────┘ └─────────┘ └─────────┘       │
│                                             │
│ 対戦数の推移（直近30日）                     │
│ ┌───────────────────────────────────────┐  │
│ │  📈 [折れ線グラフ]                    │  │
│ └───────────────────────────────────────┘  │
│                                             │
│ ┌──────────────────┐ ┌──────────────────┐ │
│ │ゲームモード別     │ │ユーザー登録数推移│ │
│ │  🥧 [円グラフ]   │ │  📊 [棒グラフ]  │ │
│ └──────────────────┘ └──────────────────┘ │
└─────────────────────────────────────────────┘
```

---

## フェーズ3: データベースメンテナンス

### 機能要件

#### 3.1 アーカイブデッキのマージ（実装済み）

- ✅ 重複するアーカイブ済みデッキを統合
- ✅ 確認ダイアログ付き
- ✅ 実行結果の表示

#### 3.2 孤立デッキのクリーンアップ（❌ 未実装）

**対象:**
- 対戦履歴が存在しない相手デッキ

**操作:**
- 「孤立データをスキャン」ボタン
- スキャン結果表示（削除候補の件数）
- 「クリーンアップ実行」ボタン（確認ダイアログ付き）
- 実行結果表示

#### 3.3 共有URLのクリーンアップ（❌ 未実装）

**対象:**
- 孤立した共有URL（ユーザー削除後に残存したURL）
- 有効期限切れの共有URL

**操作:**

1. **孤立共有URLの削除**
   - 「孤立URLをスキャン」ボタン
   - スキャン結果表示（件数）
   - 「削除実行」ボタン（確認ダイアログ付き）

2. **期限切れ共有URLの一括削除**
   - 「期限切れURLをスキャン」ボタン
   - スキャン結果表示（件数、最古の期限切れ日）
   - 「一括削除」ボタン（確認ダイアログ付き）

> **Note:** 古いデータの削除機能は、ユーザーデータの長期的な価値を考慮し、意図的に実装しない方針としました。
> ストレージコストよりもユーザーの対戦履歴を保全することを優先します。

### API設計

#### POST /admin/maintenance/scan-orphaned-data

**レスポンス:**
```json
{
  "orphaned_opponent_decks": 45,
  "total_size_mb": 2.3
}
```

#### POST /admin/maintenance/cleanup-orphaned-data

**レスポンス:**
```json
{
  "success": true,
  "deleted_decks": 45,
  "message": "45個の孤立データを削除しました"
}
```

#### POST /admin/maintenance/scan-orphaned-shared-urls

**レスポンス:**
```json
{
  "orphaned_count": 15
}
```

#### POST /admin/maintenance/cleanup-orphaned-shared-urls

**レスポンス:**
```json
{
  "success": true,
  "deleted_count": 15,
  "message": "15件の孤立した共有URLを削除しました"
}
```

#### POST /admin/maintenance/scan-expired-shared-urls

**レスポンス:**
```json
{
  "expired_count": 45,
  "oldest_expired": "2024-06-01T00:00:00Z"
}
```

#### POST /admin/maintenance/cleanup-expired-shared-urls

**レスポンス:**
```json
{
  "success": true,
  "deleted_count": 45,
  "message": "45件の期限切れ共有URLを削除しました"
}
```

### UI設計

```
┌─────────────────────────────────────────────────┐
│ データベースメンテナンス                          │
├─────────────────────────────────────────────────┤
│ 🗂️ アーカイブデッキのマージ                      │
│ 同名のアーカイブ済みデッキを統合                 │
│ [実行] ✅実装済み                                │
├─────────────────────────────────────────────────┤
│ 🗑️ 孤立デッキのクリーンアップ                    │
│ 対戦履歴が存在しない相手デッキを削除             │
│ [スキャン] [クリーンアップ実行]                  │
│ スキャン結果: 45個の孤立データが見つかりました    │
├─────────────────────────────────────────────────┤
│ 🔗 共有URLのクリーンアップ                        │
│                                                 │
│ 孤立した共有URL（ユーザー削除後の残存）          │
│ [スキャン] [削除実行]                            │
│ スキャン結果: 15件                               │
│                                                 │
│ 期限切れ共有URL                                  │
│ [スキャン] [一括削除]                            │
│ スキャン結果: 45件（最古: 2024-06-01）           │
└─────────────────────────────────────────────────┘
```

---

## フェーズ4: メタ分析

> **将来の公開化について:** 現時点では管理者専用機能として実装しますが、
> 将来的にはユーザー向けの「環境分析」ページとして公開する可能性があります。
> そのため、APIは再利用可能な設計とし、管理者向けの詳細データと
> 公開向けの集約データを分離できる構造にします。

### 機能要件

#### 4.1 人気デッキランキング

**表示項目:**
- 順位
- デッキ名
- 使用者数（ユニークユーザー数）
- 総使用回数（対戦数）
- 勝率

**フィルタ:**
- 期間: 直近7日 / 30日 / 90日 / 全期間
- ゲームモード: ALL / RANK / RATE / DC / EVENT
- 最小使用回数: 集計対象の閾値（デフォルト: 10回以上）

#### 4.2 デッキ使用率推移

**表示:**
- 上位N件のデッキの使用率を折れ線グラフで表示
- 期間: 直近30日（日別）または12週間（週別）

**用途:**
- 環境の変化を可視化
- 新デッキの台頭や既存デッキの衰退を追跡

#### 4.3 ゲームモード別統計

**表示:**
- 各ゲームモードの対戦数比率（円グラフ）
- 各ゲームモードのアクティブユーザー数

### API設計

#### GET /admin/meta/popular-decks

**クエリパラメータ:**
- `period`: `7d` | `30d` | `90d` | `all`（デフォルト: `30d`）
- `game_mode`: `ALL` | `RANK` | `RATE` | `DC` | `EVENT`（デフォルト: `ALL`）
- `min_usage`: 最小使用回数（デフォルト: 10）
- `limit`: 取得件数（デフォルト: 20、最大: 100）

**レスポンス:**
```json
{
  "period": "30d",
  "game_mode": "ALL",
  "total_duels": 12345,
  "total_unique_decks": 456,
  "rankings": [
    {
      "rank": 1,
      "deck_name": "ティアラメンツ",
      "unique_users": 234,
      "total_usage": 1567,
      "win_rate": 58.2,
      "usage_rate": 12.7
    },
    {
      "rank": 2,
      "deck_name": "スネークアイ",
      "unique_users": 198,
      "total_usage": 1234,
      "win_rate": 55.1,
      "usage_rate": 10.0
    }
  ]
}
```

#### GET /admin/meta/deck-trends

**クエリパラメータ:**
- `period`: `daily` | `weekly`（デフォルト: `daily`）
- `days`: 日数（デフォルト: 30、最大: 90）
- `limit`: 上位何デッキを表示（デフォルト: 5）

**レスポンス:**
```json
{
  "period": "daily",
  "deck_names": ["ティアラメンツ", "スネークアイ", "炎王", "ユベル", "粛声"],
  "timeline": [
    {
      "date": "2025-01-01",
      "usage_rates": {
        "ティアラメンツ": 12.5,
        "スネークアイ": 10.2,
        "炎王": 8.1,
        "ユベル": 7.5,
        "粛声": 6.8
      }
    }
  ]
}
```

#### GET /admin/meta/game-mode-stats

**レスポンス:**
```json
{
  "total_duels": 45678,
  "modes": [
    {
      "mode": "RANK",
      "duel_count": 20555,
      "percentage": 45.0,
      "active_users": 890
    },
    {
      "mode": "RATE",
      "duel_count": 13703,
      "percentage": 30.0,
      "active_users": 567
    },
    {
      "mode": "DC",
      "duel_count": 6852,
      "percentage": 15.0,
      "active_users": 345
    },
    {
      "mode": "EVENT",
      "duel_count": 4568,
      "percentage": 10.0,
      "active_users": 234
    }
  ]
}
```

### UI設計

```
┌─────────────────────────────────────────────────────────┐
│ メタ分析                                                 │
├─────────────────────────────────────────────────────────┤
│ フィルタ: [30日 ▼] [全モード ▼] [最小10回 ▼]            │
├─────────────────────────────────────────────────────────┤
│                                                         │
│ 📊 人気デッキランキング                                  │
│ ┌────┬──────────────┬────────┬────────┬───────┬──────┐│
│ │順位│デッキ名       │使用者数│使用回数 │勝率   │使用率││
│ ├────┼──────────────┼────────┼────────┼───────┼──────┤│
│ │ 1  │ティアラメンツ │  234   │ 1,567  │58.2%  │12.7% ││
│ │ 2  │スネークアイ   │  198   │ 1,234  │55.1%  │10.0% ││
│ │ 3  │炎王          │  156   │   987  │52.3%  │ 8.0% ││
│ │ 4  │ユベル        │  134   │   876  │51.8%  │ 7.1% ││
│ │ 5  │粛声          │  123   │   765  │50.2%  │ 6.2% ││
│ │... │              │        │        │       │      ││
│ └────┴──────────────┴────────┴────────┴───────┴──────┘│
│                                                         │
│ 📈 デッキ使用率推移（上位5デッキ）                        │
│ ┌─────────────────────────────────────────────────────┐│
│ │  [折れ線グラフ]                                     ││
│ │  --- ティアラメンツ  --- スネークアイ  --- 炎王    ││
│ │  --- ユベル         --- 粛声                       ││
│ └─────────────────────────────────────────────────────┘│
│                                                         │
│ 🎮 ゲームモード別統計                                    │
│ ┌────────────────────────┐ ┌────────────────────────┐ │
│ │   [円グラフ]           │ │ モード │ 対戦数 │ユーザー│ │
│ │   RANK: 45%            │ │ RANK   │ 20,555 │  890  │ │
│ │   RATE: 30%            │ │ RATE   │ 13,703 │  567  │ │
│ │   DC:   15%            │ │ DC     │  6,852 │  345  │ │
│ │   EVENT:10%            │ │ EVENT  │  4,568 │  234  │ │
│ └────────────────────────┘ └────────────────────────┘ │
└─────────────────────────────────────────────────────────┘
```

### プライバシー考慮事項

- **集計のみ:** 個別ユーザーの対戦データは公開せず、集計値のみを表示
- **最小閾値:** 使用回数が少なすぎるデッキは集計から除外（個人特定防止）
- **デッキ名のみ:** ユーザー名は一切表示しない

### 将来の公開機能化に向けて

管理者専用から公開機能に移行する際の変更点:

| 項目 | 管理者向け | 公開向け |
|------|-----------|---------|
| エンドポイント | `/admin/meta/*` | `/public/meta/*` |
| 認証 | 必要 | 不要 |
| 詳細度 | 詳細（使用者数など） | 簡略化（順位・勝率のみ） |
| 最小閾値 | 低め（10回） | 高め（50回以上） |
| 更新頻度 | リアルタイム | キャッシュ（1時間） |

---

## 技術的考慮事項

### パフォーマンス

- **ユーザー一覧**: ページネーション実装必須
- **統計情報**: キャッシュ機構の検討（Redis使用を検討）
- **大規模データ処理**: バックグラウンドジョブ化を検討（Celery等）

### エラーハンドリング

- すべての管理者操作でトランザクション使用
- エラー時は詳細なログ記録
- ユーザーにわかりやすいエラーメッセージ表示

### 監査ログ（将来的な拡張）

- 管理者操作の記録
- 誰が、いつ、何を実行したか
- 新規テーブル `admin_audit_logs` の追加

---

## 実装順序

1. **フェーズ1: ユーザー管理**（✅ 完了）
   - バックエンドAPI実装
   - フロントエンドUI実装
   - テストと調整

2. **フェーズ2: システム統計**（優先度: 高）
   - 統計API実装（概要、対戦数推移、ユーザー登録推移）
   - ダッシュボードUI実装
   - Chart.jsによるグラフ表示の実装

3. **フェーズ3: データベースメンテナンス**（優先度: 中）
   - 孤立デッキ スキャン・クリーンアップAPI実装
   - 共有URL スキャン・クリーンアップAPI実装（孤立・期限切れ）
   - レガシーテーブル `sharedurls` の移行・削除
   - フロントエンドUI実装

4. **フェーズ4: メタ分析**（優先度: 中）
   - 人気デッキランキングAPI実装
   - デッキ使用率推移API実装
   - ゲームモード別統計API実装
   - Chart.jsによるグラフ表示の実装
   - （将来）公開機能への移行検討

---

## 参考リンク

- [バックエンドアーキテクチャ](./backend-architecture.md)
- [フロントエンドアーキテクチャ](./frontend-architecture.md)
- [DBスキーマ](./db-schema.md)
- [アーカイブデッキマージ設計](./archive-deck-merge-design.md)
- [共有機能設計](./sharing-feature-design.md)
