# デッキアーカイブのマージ機能 設計

このドキュメントは、デッキのアーカイブ機能を改善し、同じ名前のデッキが複数アーカイブされることを防ぐためのマージ機能に関する設計を定義します。

## 1. 概要

ユーザーがデッキをアーカイブする際、すでに同じ名前のデッキがアーカイブされている場合、新規にアーカイブするのではなく、既存のアーカイブ済みデッキに対戦履歴（デュエル情報）を統合（マージ）します。これにより、アーカイブリストの重複をなくし、データの整合性を高めます。

## 2. 背景と目的

現状では、同じ名前のデッキ（例：「ブルーアイズ」）を異なる時期に作成・使用し、それぞれをアーカイブすると、アーカイブリストに複数の「ブルーアイズ」が表示されてしまいます。これはユーザーにとって混乱を招き、過去の戦績分析を困難にします。

この機能を導入することで、以下の目的を達成します。
- **データの一元管理**: 同じデッキの戦績を一つのアーカイブ済みデッキに集約します。
- **UXの向上**: アーカイブリストを整理し、ユーザーが目的のデッキを見つけやすくします。
- **統計の正確性向上**: デッキごとの正確な累計戦績を保持できるようにします。

## 3. 設計方針

### 3.1. APIエンドポイント

デッキの更新を担当する `PUT /decks/{deck_id}` エンドポイントのロジックを拡張して対応します。
リクエストボディで `active: false` を受け取った場合を「アーカイブ操作」と見なします。

- **エンドポイント**: `PUT /decks/{deck_id}`
- **トリガー**: リクエストボディに `{"active": false}` が含まれる場合。

### 3.2. ビジネスロジック (Serviceレイヤー)

`deck_service.py` 内のデッキ更新処理（`update_deck`など）に以下のロジックを実装します。

1.  **アーカイブ操作の検知**:
    - リクエストされたデッキ（`Deck A`）の更新データに `active: false` が含まれていることを確認します。

2.  **既存アーカイブデッキの検索**:
    - `Deck A` と同じ `name` を持ち、かつ `active: false` のデッキ（`Deck B`）がデータベースに存在するかを検索します。
    - 検索対象は、同じ `user_id` に属するデッキに限定します。

3.  **ロジックの分岐**:

    -   **もし `Deck B` が存在する場合 (マージ処理)**:
        1.  **デュエル情報の移行**: `Deck A` に紐づいている全ての `duels` レコードを取得し、それらの `deck_id` を `Deck B` の `id` に更新します。
        2.  **`opponentDeck_id` の移行**: `Deck A` が対戦相手のデッキとして使用されている `duels` レコードを取得し、それらの `opponentDeck_id` を `Deck B` の `id` に更新します。
        3.  **重複デッキの削除**: デュエル情報の移行が完了した後、`Deck A` をデータベースから削除します。
        4.  **レスポンス**: 統合先となった `Deck B` の情報をレスポンスとして返却します。

    -   **もし `Deck B` が存在しない場合 (通常のアーカイブ処理)**:
        1.  従来通り、`Deck A` の `active` フラグを `false` に設定して更新します。
        2.  更新後の `Deck A` の情報をレスポンスとして返却します。

### 3.3. データベース操作

- **UPDATE**: `duels` テーブルにて、`deck_id` または `opponentDeck_id` が `Deck A` のIDと一致するレコードを、`Deck B` のIDに更新します。
- **DELETE**: `decks` テーブルから `Deck A` のレコードを削除します。

これらの操作は、アトミック性を保証するため、単一のデータベーストランザクション内で実行する必要があります。

## 4. 影響範囲

- **`backend/app/services/deck_service.py`**:
  - メインのビジネスロジックを実装します。
- **`backend/app/api/routers/decks.py`**:
  - サービスレイヤーの呼び出し部分は変更不要ですが、レスポンスの挙動が変わることを認識する必要があります。
- **`backend/app/models/duel.py`**:
  - `deck_id` と `opponentDeck_id` のリレーションシップを利用して更新クエリを構築します。

## 5. データベーススキーマへの影響

なし。既存のテーブル構造やカラムに変更は加えません。

## 6. API仕様の変更

`PUT /decks/{deck_id}` の挙動が以下のように変更されます。

- **リクエスト**: 変更なし。
- **レスポンス**:
  - マージが発生した場合、リクエストで指定した `{deck_id}` のデッキは削除され、レスポンスボディには **統合先のデッキ情報** が返却されます。
  - 通常のアーカイブの場合、従来通り更新されたデッキの情報が返却されます。
- フロントエンドは、このレスポンスボディのIDがリクエスト時のIDと異なる可能性があることを考慮して実装する必要があります。
