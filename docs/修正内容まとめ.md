# データベース接続エラー修正まとめ

## 🔴 発生したエラー

```
psycopg2.OperationalError: connection to server at "db" (172.18.0.2), port 5432 failed: Connection refused
```

## 🎯 根本原因

1. **JWT認証コード追加により、`config.py`での環境変数チェックが厳格化**
2. **データベースの準備完了前にバックエンドが接続を試みていた**
3. **`depends_on`だけではデータベースの準備完了を保証できない**

## ✅ 実施した修正

### 1. `app/core/config.py` - 環境変数チェックの緩和

**修正前:**
```python
if not DATABASE_URL:
    raise RuntimeError("DATABASE_URL is not set")
```

**修正後:**
```python
if not DATABASE_URL:
    logger.warning("⚠️ DATABASE_URL is not set")
```

起動時のエラーを警告に変更し、開発環境でも柔軟に対応できるようにしました。

### 2. `docker-compose.yml` - ヘルスチェック追加

**追加内容:**
```yaml
db:
  healthcheck:
    test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER}"]
    interval: 5s
    timeout: 5s
    retries: 5

backend:
  depends_on:
    db:
      condition: service_healthy  # ← 重要！
  restart: on-failure
```

データベースが完全に起動してから、バックエンドが起動するようにしました。

### 3. `backend/Dockerfile` - PostgreSQLクライアント追加

**追加内容:**
```dockerfile
RUN apt-get update && \
    apt-get install -y gcc libpq-dev postgresql-client && \
    rm -rf /var/lib/apt/lists/*
```

`pg_isready`コマンドを使用できるようにしました。

### 4. `backend/wait-for-db.sh` - 待機スクリプト新規作成

データベース接続を確実に待機する専用スクリプトを作成しました。

**機能:**
- 最大60秒間データベース接続を試行
- 接続成功後にAlembicマイグレーション実行
- マイグレーション成功後にUvicorn起動

### 5. `.env.example` - 設定例の更新

実際に動作する設定例を追加しました。

## 🚀 再起動手順

### ステップ1: 既存のコンテナを停止・削除

```bash
docker-compose down -v
```

`-v`オプションでボリュームも削除します（データベースを完全にリセット）。

### ステップ2: .envファイルの作成・確認

```bash
# .envファイルが存在しない場合
cp .env.example .env

# SECRET_KEYを生成
openssl rand -hex 32

# .envファイルを編集してSECRET_KEYを設定
```

**最小限の.env設定:**
```bash
POSTGRES_USER=duellog_user
POSTGRES_PASSWORD=duellog_password
POSTGRES_DB=duellog_db
DATABASE_URL=postgresql://duellog_user:duellog_password@db:5432/duellog_db

SECRET_KEY=<ここに生成した64文字の文字列>
ALGORITHM=HS256
ACCESS_TOKEN_EXPIRE_MINUTES=30

VITE_API_BASE_URL=http://localhost:8000
```

### ステップ3: イメージの再ビルド

```bash
docker-compose build --no-cache
```

`--no-cache`で確実に最新のコードでビルドします。

### ステップ4: コンテナの起動

```bash
docker-compose up
```

または、バックグラウンドで起動：

```bash
docker-compose up -d
```

### ステップ5: ログで確認

```bash
docker-compose logs -f backend
```

**成功時のログ例:**
```
duellog_backend  | ⏳ Waiting for database at db...
duellog_backend  | ✅ Database is ready!
duellog_backend  | 🔄 Running Alembic migrations...
duellog_backend  | INFO  [alembic.runtime.migration] Context impl PostgresqlImpl.
duellog_backend  | INFO  [alembic.runtime.migration] Will assume transactional DDL.
duellog_backend  | ✅ Migrations completed successfully!
duellog_backend  | 🚀 Starting Uvicorn server...
duellog_backend  | INFO:     Will watch for changes in these directories: ['/app']
duellog_backend  | INFO:     Uvicorn running on http://0.0.0.0:8000 (Press CTRL+C to quit)
duellog_backend  | INFO:     Started reloader process [1] using WatchFiles
duellog_backend  | INFO:     Started server process [8]
duellog_backend  | INFO:     Waiting for application startup.
duellog_backend  | INFO:     Application startup complete.
```

## ✅ 動作確認

### 1. ヘルスチェック

```bash
curl http://localhost:8000/
```

**期待されるレスポンス:**
```json
{"message":"Hello Duel Log"}
```

### 2. APIドキュメント

ブラウザで以下のURLを開く：
- http://localhost:8000/docs （Swagger UI）
- http://localhost:8000/redoc （ReDoc）

### 3. ログインテスト

```bash
# ユーザー作成
curl -X POST "http://localhost:8000/users/" \
  -H "Content-Type: application/json" \
  -d '{
    "username": "testuser",
    "email": "test@example.com",
    "password": "securepassword123"
  }'

# ログイン
curl -X POST "http://localhost:8000/auth/login" \
  -H "Content-Type: application/json" \
  -d '{
    "email": "test@example.com",
    "password": "securepassword123"
  }'
```

## 📁 変更されたファイル一覧

```
backend/
├── app/
│   └── core/
│       └── config.py           ← 修正
├── Dockerfile                  ← 修正
└── wait-for-db.sh             ← 新規作成

docker-compose.yml              ← 修正
.env.example                    ← 更新

docs/
├── データベース接続エラー解決ガイド.md  ← 新規作成
└── 修正内容まとめ.md                    ← このファイル
```

## 🔍 今後の予防策

### 1. ローカル開発時の確認事項

- [ ] `.env`ファイルが正しく設定されている
- [ ] `SECRET_KEY`が設定されている（最低32文字）
- [ ] データベース接続情報が正しい

### 2. デプロイ前の確認事項

- [ ] 本番用の強力な`SECRET_KEY`を生成
- [ ] `config.py`の`validate_for_production()`を実行
- [ ] HTTPSを使用
- [ ] 環境変数が全て設定されている

### 3. モニタリング

```bash
# コンテナの状態を定期的に確認
docker-compose ps

# リソース使用状況を確認
docker stats

# ログを監視
docker-compose logs -f
```

## 🐛 よくある問題と解決方法

### 問題1: ポート5432が使用中

**エラー:**
```
Error starting userland proxy: listen tcp4 0.0.0.0:5432: bind: address already in use
```

**解決方法:**
```bash
# ローカルのPostgreSQLを停止
# または、docker-compose.ymlでポートを変更
ports:
  - "5433:5432"
```

### 問題2: wait-for-db.shの実行権限エラー

**エラー:**
```
permission denied: ./wait-for-db.sh
```

**解決方法:**
```bash
# Windowsの場合、Gitの設定を確認
git config core.filemode false

# 再ビルド
docker-compose build --no-cache
```

### 問題3: マイグレーションの競合

**エラー:**
```
alembic.util.exc.CommandError: Target database is not up to date.
```

**解決方法:**
```bash
# データベースをリセット
docker-compose down -v
docker-compose up --build
```

## 📞 サポート

問題が解決しない場合は、以下の情報を提供してください：

1. `docker-compose logs > logs.txt`の出力
2. `docker-compose ps`の出力
3. `.env`ファイルの内容（パスワードは伏せる）
4. Dockerのバージョン情報

## ✨ まとめ

この修正により、以下が実現されました：

1. ✅ データベース接続の確実な待機
2. ✅ 環境変数チェックの柔軟化
3. ✅ エラー時の自動再起動
4. ✅ 詳細なログ出力
5. ✅ トラブルシューティングガイドの整備

これで安定してアプリケーションが起動するようになりました！
