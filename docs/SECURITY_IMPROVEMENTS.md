# セキュリティ改善レポート

## 概要

アプリケーションのセキュリティ脆弱性を特定し、修正を実施しました。主な改善点は、認証トークンの窃取に繋がるクロスサイトスクリプティング（XSS）攻撃への耐性を大幅に向上させたことです。

---

## 1. 認証トークンの保存方法の変更 (最重要)

### 脆弱性

- **問題点:** 従来の実装では、認証トークン（JWT）をブラウザの `localStorage` に保存していました。`localStorage` はJavaScriptから簡単にアクセスできるため、XSS攻撃に成功した攻撃者がトークンを窃取し、ユーザーになりすますことが可能でした。
- **リスク:** **高**

### 修正内容

- **対策:** トークンの保存場所を `localStorage` からサーバー管理の **`HttpOnly` クッキー** に変更しました。

- **変更点:**
    1.  **バックエンド (`/auth/login`):**
        - ログイン成功時、レスポンスボディでトークンを返すのではなく、`Set-Cookie` ヘッダーを用いて `HttpOnly`, `Secure`, `SameSite=Lax` 属性を持つクッキーにトークンを格納するように変更しました。
        - `HttpOnly` 属性により、JavaScriptからこのクッキーへのアクセスがブロックされます。

    2.  **バックエンド (認証DI):**
        - `Authorization: Bearer` ヘッダーからトークンを読み取る代わりに、リクエストに含まれる `access_token` クッキーからトークンを読み取るように `get_current_user` を修正しました。

    3.  **バックエンド (`/auth/logout`):**
        - `access_token` クッキーを無効化するログアウトエンドポイントを新たに追加しました。

    4.  **フロントエンド (`auth.ts`, `api.ts`):**
        - `localStorage` に関連するすべてのコードを削除しました。
        - `Authorization` ヘッダーを手動で付与するリクエストインターセプターを削除しました。認証クッキーはブラウザによって自動的にリクエストに添付されます。
        - アプリケーション起動時に、サーバーにユーザー情報を問い合わせることで認証状態を確認する、より堅牢な初期化フローを実装しました。

### 効果

- XSS攻撃によるトークン窃取のリスクを**劇的に低減**させました。

---

## 2. パスワードポリシーの強化

### 脆弱性・問題点

- **問題点1:** パスワードの最小長に関する要件がなく、ユーザーが脆弱なパスワード（例: `1234`）を設定可能でした。
- **問題点2:** バックエンドで使用している `bcrypt` ライブラリの仕様により、72バイトを超えるパスワードは警告なしに切り捨てられていました。これにより、ユーザーが設定したつもりのパスワードと、実際に保存されているパスワードが異なるという意図しない状況が発生していました。
- **リスク:** **低〜中**

### 修正内容

- **対策:** ユーザー登録・更新時に受け取るデータスキーマ（Pydanticモデル）にバリデーションルールを追加しました。

- **変更点 (`schemas/user.py`):
    - `UserCreate` および `UserUpdate` スキーマの `password` フィールドに、以下の制約を追加しました。
        - `min_length=8` （最小8文字）
        - `max_length=72` （最大72文字）
    - これにより、要件を満たさないパスワードはAPIレベルで弾かれ、ユーザーに明確なエラーが返されるようになりました。

### 効果

- パスワードの最低限の強度を保証し、意図しないパスワードの切り捨てを防ぐことで、ユーザー体験とセキュリティを向上させました。

---

## まとめ

上記2点の修正により、アプリケーションの認証基盤がより堅牢になり、主要なセキュリティリスクが軽減されました。今後は、定期的な依存関係の脆弱性スキャンや、セキュリティヘッダーの追加（HSTSなど）を検討していくことが推奨されます。
