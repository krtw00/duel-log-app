# 画面録画分析設計

ブラウザの画面録画から対戦中の特定シーンを検出し、イベントとして取り込む機能。

---

## 実装状況

| 機能 | 状態 |
|------|------|
| コイントス結果検出 | ✅ `turnChoice` 設定 |
| 勝敗判定（VICTORY/LOSE） | ✅ テンプレートマッチング |
| 複数解像度対応（720p〜2160p） | ✅ MIPMAPアプローチ |
| ユーザー設定ON/OFF | ✅ `enable_screen_analysis` |
| 対戦入力UIへの統合 | ✅ DuelFormDialog.vue |
| 自動対戦記録作成 | ❌ 未実装 |
| FSM状態管理 | ⚠️ 部分実装 |

---

## 検出対象

| 対象 | 説明 |
|------|------|
| 先攻/後攻選択画面 | 選択権ありを検出 |
| 勝敗画面 | VICTORY/LOSE判定 |

---

## アーキテクチャ

```
フレーム取得 → 正規化 → ROI抽出 → 画像特徴化 → テンプレ一致 → FSM確定
```

### パイプライン

| ステップ | 説明 |
|---------|------|
| フレーム取得 | `getDisplayMedia()` + `MediaStreamTrackProcessor` |
| 正規化 | 幅1280pxにリサイズ（16:9基準） |
| ROI抽出 | 固定領域切り出し |
| 特徴化 | グレースケール + エッジ抽出 |
| マッチング | テンプレートマッチ（NCC系） |
| 確定 | FSMで時系列管理 |

---

## 解析パラメータ

| パラメータ | 値 |
|-----------|-----|
| 通常スキャン | 2〜5 fps |
| 重要シーン | 10〜15 fps |
| 確定条件 | 3フレーム連続一致 |
| クールダウン | 8〜15秒 |

---

## テンプレート管理

### MIPMAPアプローチ

| ステップ | 説明 |
|---------|------|
| マスター読込 | 4K高品質テンプレート1枚 |
| 動的リサイズ | 全解像度版を生成 |
| キャッシュ | 前処理済みデータをメモリ保持 |
| 選択 | 入力解像度に最も近いテンプレート使用 |

### 対応解像度

720p, 768p, 810p, 900p, 1080p, 1152p, 1440p, 1800p, 2160p

---

## FSM状態

| 状態 | 説明 |
|------|------|
| `Idle` | 待機中 |
| `TurnChoiceAvailable` | 選択権あり |
| `TurnChoiceLocked` | 確定・変更不可 |
| `ResultDetected` | 勝敗確定 |
| `Cooldown` | 二重計上防止 |

---

## プライバシー

| 項目 | 対策 |
|------|------|
| 処理場所 | クライアント（ブラウザ）内で完結 |
| 送信データ | フレーム画像は送信しない |
| 保存 | イベント・メタ情報のみ（画像はオプトイン） |

---

## 実装ファイル

| ファイル | 説明 |
|---------|------|
| `frontend/src/utils/screenAnalysis.ts` | 解析ロジック |
| `frontend/src/views/ProfileView.vue` | 設定UI |
| `frontend/src/components/duel/DuelFormDialog.vue` | 対戦入力統合 |
| `backend/app/models/user.py` | `enable_screen_analysis` |
| `public/screen-analysis/` | テンプレート画像 |

---

## 関連ドキュメント

| ドキュメント | 内容 |
|------------|------|
| @../02-architecture/frontend-architecture.md | フロントエンド構造 |
| @../04-data/data-model.md | データモデル |
