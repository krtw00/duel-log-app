# 配信者モード機能

## 概要
配信者モード（Streamer Mode）は、ライブ配信や録画時にユーザーのプライバシーを保護するための機能です。
この機能を有効にすると、アプリケーション内のメールアドレスが自動的にマスクされます。

## 機能詳細

### 1. ログイン画面でのメールアドレス入力欄の非表示
- **配信者モード OFF**: 通常の`type="email"`で表示
- **配信者モード ON**: CSSで入力内容を視覚的に隠す（`color: transparent` + `text-shadow`）
  - `type="password"`は使用しない（ブラウザのパスワード自動入力との干渉を防ぐため）
  - 文字は透明だが、紫色のグロー効果で入力されていることを視覚的に示す
- **ヒント表示**: 配信者モード有効時は「配信者モードが有効なため、入力内容は非表示になります」と表示

### 2. メールアドレスの自動保存と復元
- **保存タイミング**: ログイン成功時にローカルストレージに保存
- **復元タイミング**: ログイン画面表示時に自動的に復元
- **ストレージキー**: `lastEmail`
- **ログアウト後**: 設定とメールアドレスの両方が保持される

### 3. ログイン後のメールアドレスマスキング
- **有効時**: `example@gmail.com` → `e*****e@g***l.com`
- **無効時**: `example@gmail.com` （そのまま表示）

### 2. 設定箇所
配信者モードは以下の場所で設定・確認できます：

#### ログイン画面
- ログイン前でも配信者モードを有効化可能
- **配信者モード ON時**: メールアドレス入力欄が`type="password"`になり入力内容が非表示
- **メールアドレス保存**: ログイン成功時にローカルストレージに自動保存
- **自動復元**: 次回ログイン画面表示時に前回のメールアドレスを自動入力
- 設定はローカルストレージに保存され、ログアウト後も保持

#### プロフィール画面
- ログイン後、プロフィール編集画面で切り替え可能
- データベースに設定が保存される
- リアルタイムでメールアドレスの表示が切り替わる

#### アプリバー（ヘッダー）
- ユーザーメニューに配信者モード状態が表示される
- 配信者モード有効時は紫色のアイコンとビデオアイコンが表示
- ドロップダウンメニューでマスクされたメールアドレスを確認可能

## データベーススキーマ

### Users テーブル
```sql
ALTER TABLE users ADD COLUMN streamer_mode BOOLEAN NOT NULL DEFAULT false;
```

## API仕様

### ユーザー情報取得 (GET /me)
**レスポンス**
```json
{
  "id": 1,
  "username": "player123",
  "email": "example@gmail.com",
  "streamer_mode": true,
  "createdat": "2025-01-01T00:00:00Z",
  "updatedat": "2025-01-01T00:00:00Z"
}
```

### ユーザー情報更新 (PUT /me/)
**リクエスト**
```json
{
  "username": "player123",
  "email": "example@gmail.com",
  "streamer_mode": true
}
```

## フロントエンド実装

### ストア (auth.ts)
```typescript
// 配信者モードの状態管理
const isStreamerModeEnabled = computed(() => {
  return user.value ? user.value.streamer_mode : localStreamerMode.value
})

// ローカルストレージへの保存
const toggleStreamerMode = (enabled: boolean) => {
  localStreamerMode.value = enabled
  localStorage.setItem('streamerMode', enabled.toString())
}
```

### ユーティリティ (maskEmail.ts)
```typescript
export const maskEmail = (email: string): string => {
  // example@gmail.com → e*****e@g***l.com
}
```

## 使用方法

### ログイン前に設定する場合
1. ログイン画面で「配信者モード」スイッチを有効化
2. ログイン
3. 設定がユーザーアカウントに保存される

### ログイン後に設定する場合
1. プロフィール画面を開く
2. 「配信者モード」セクションでスイッチを切り替え
3. 「更新」ボタンをクリック

## 技術的な詳細

### ローカルストレージとユーザー設定の優先順位
- **ログイン前**: ローカルストレージの設定を使用
- **ログイン後**: データベースに保存されたユーザー設定を使用
- **ログアウト後**: ローカルストレージの設定に戻る（設定は保持される）

### マスキングロジック
- ローカル部分: 最初と最後の文字を残し、中間をアスタリスクに置換
- ドメイン部分: 各セグメント（ピリオド区切り）ごとに最初と最後の文字を残す
- 2文字以下の部分: 全てアスタリスクに置換

## マイグレーション

```bash
# マイグレーション適用
cd backend
alembic upgrade head
```

マイグレーションファイル: `e1f2a3b4c5d6_add_streamer_mode_to_users.py`

## セキュリティ考慮事項
- マスキングはフロントエンドでのみ行われる（表示用）
- API通信では常に実際のメールアドレスが使用される
- ローカルストレージには boolean 値のみ保存
- 実際のメールアドレスはデータベースに安全に保存

## テスト項目
- [ ] ログイン前の配信者モード切り替え
- [ ] ログイン後の設定保存
- [ ] プロフィール画面での切り替え
- [ ] メールアドレスのマスキング表示
- [ ] ログアウト後の設定保持
- [ ] アプリバーでの表示切り替え
- [ ] APIでの正常な更新
