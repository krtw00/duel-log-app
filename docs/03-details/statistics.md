---
depends_on: []
tags: [appendix, feature, statistics]
ai_summary: "統計・分析機能の設計仕様"
---

# 統計分析機能

> Status: Active
> 最終更新: 2026-01-23

勝率、相性表、トレンド分析などの統計表示機能

---

## 概要

| 項目 | 内容 |
|------|------|
| 目的 | 統計分析機能の設計ドキュメント |
| 状態 | ✅ 実装済み |
| 対象読者 | 開発者 |

---

## 統計種別

### 基本統計

| 項目 | 説明 |
|------|------|
| 総対戦数 | 期間内の全対戦数 |
| 勝率 | 勝利数 / 総対戦数 × 100% |
| 先攻勝率 | 先攻時の勝率 |
| 後攻勝率 | 後攻時の勝率 |
| コイン勝率 | コイントス勝率 |
| 先攻率 | 先攻になった割合 |

### デッキ統計

| 項目 | 説明 |
|------|------|
| デッキ別勝率 | 各デッキの勝率 |
| デッキ使用分布 | デッキの使用頻度 |
| 相性表 | デッキ間の勝敗マトリクス |

### トレンド

| 項目 | 説明 |
|------|------|
| 連勝/連敗 | 最長連勝・連敗、現在の状態 |
| 日別推移 | 日ごとの勝率推移 |
| ランク/レート推移 | 対戦ごとのrank/rate_value/dc_valueの変動グラフ |

---

## フィルタ

| フィルタ | オプション |
|---------|----------|
| 期間 | 全期間、今月、今週、カスタム |
| ゲームモード | RANK, RATE, EVENT, DC |
| デッキ | 特定デッキのみ |

---

## データフロー

```
┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐
│  Filter Input   │────▶│  TanStack Query │────▶│  Statistics API │
│  (期間/モード)   │     │  (queryKey)     │     │  (集計処理)     │
└─────────────────┘     └─────────────────┘     └─────────────────┘
                                │
                                ▼
                        ┌─────────────────┐
                        │  Statistics UI  │
                        │  (カード/グラフ) │
                        └─────────────────┘
```

---

## キャッシュ戦略

### TanStack Query設定

| 設定項目 | 値 | 説明 |
|---------|-----|------|
| queryKey | `['statistics', filters]` | フィルタ条件をキーに含む |
| staleTime | 5分 | 5分間はキャッシュを新鮮と見なす |
| gcTime | 30分 | 30分後にキャッシュを破棄 |

フィルタ条件（gameMode, period, deckId）をqueryKeyに含めることで、条件ごとに個別にキャッシュされる。

### 無効化トリガー

| イベント | 無効化対象 |
|---------|-----------|
| 対戦作成 | 全統計 |
| 対戦更新 | 全統計 |
| 対戦削除 | 全統計 |

---

## 相性表（Matchup Matrix）

### データ構造

**MatchupCell**（各セルのデータ）:

| フィールド | 型 | 説明 |
|-----------|-----|------|
| deckId | UUID | 自デッキID |
| opponentDeckId | UUID | 相手デッキID |
| wins | number | 勝利数 |
| losses | number | 敗北数 |
| winRate | number | 勝率（0〜100） |

**MatchupMatrix**（マトリクス全体）:

| フィールド | 型 | 説明 |
|-----------|-----|------|
| decks | Deck[] | 対象デッキ一覧 |
| cells | MatchupCell[][] | 2次元配列（行: 自デッキ、列: 相手デッキ） |

### 表示形式

| | デッキA | デッキB | デッキC |
|---|---|---|---|
| **デッキA** | - | 60% (6-4) | 45% (9-11) |
| **デッキB** | 40% (4-6) | - | 55% (11-9) |
| **デッキC** | 55% (11-9) | 45% (9-11) | - |

---

## API

| エンドポイント | 説明 |
|---------------|------|
| `GET /api/statistics/overview` | 概要統計 |
| `GET /api/statistics/win-rate` | 勝率詳細 |
| `GET /api/statistics/matchups` | 相性表 |
| `GET /api/statistics/streaks` | 連勝/連敗 |
| `GET /api/statistics/value-sequence` | ランク/レート推移 |

---

## パフォーマンス考慮

| 課題 | 対策 |
|------|------|
| 大量データ集計 | 期間フィルタでデータ量制限 |
| N+1クエリ | JOINクエリで一括取得 |
| 重複計算 | TanStack Queryキャッシュ |

---

## 関連ドキュメント

| ドキュメント | 内容 |
|------------|------|
| [API仕様](../../03-details/api.md) | API仕様 |
| [統計共有](./sharing.md) | 統計共有 |
| [配信者ポップアップ](./streamer-popup.md) | 配信者ポップアップ |
