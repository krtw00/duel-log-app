---
depends_on: []
tags: [appendix, feature, streamer]
ai_summary: "配信者ポップアップ機能の設計仕様"
---

# 配信者ポップアップ

> Status: Active
> 最終更新: 2026-01-23

OBSウィンドウキャプチャ方式の配信者向け統計表示

---

## 概要

| 項目 | 内容 |
|------|------|
| 目的 | 配信者ポップアップの設計ドキュメント |
| 状態 | ✅ 実装済み |
| 対象読者 | 開発者 |

---

## 特徴

| 項目 | 内容 |
|------|------|
| 認証方式 | 通常のSupabase Auth（トークン不要） |
| 取込方式 | OBS「ウィンドウキャプチャ」 |
| 設定保存 | ローカルストレージ |

---

## リアルタイム更新

### 更新方式

| 方式 | 用途 |
|------|------|
| BroadcastChannel | 同一ブラウザ内での即時通知 |
| スマートポーリング | BroadcastChannel非対応時のフォールバック |

### データフロー

```
┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐
│ 対戦記録作成    │────▶│ BroadcastChannel│────▶│ ポップアップ    │
│                │     │ 通知            │     │ 更新            │
└─────────────────┘     └─────────────────┘     └─────────────────┘
        │
        ▼
┌─────────────────┐
│ フォールバック   │
│ 30秒ポーリング  │
└─────────────────┘
```

---

## 表示項目

| キー | ラベル | デフォルト |
|------|--------|:--------:|
| `current_deck` | 使用デッキ | ❌ |
| `game_mode_value` | ランク/レート値 | ❌ |
| `total_duels` | 対戦数 | ❌ |
| `win_rate` | 勝率 | ✅ |
| `first_turn_win_rate` | 先攻勝率 | ❌ |
| `second_turn_win_rate` | 後攻勝率 | ❌ |
| `coin_win_rate` | コイン勝率 | ❌ |
| `go_first_rate` | 先攻率 | ❌ |

---

## 設定項目

### 基本設定

| 項目 | オプション | デフォルト |
|------|-----------|----------|
| ゲームモード | RANK / RATE / EVENT / DC | RANK |
| 統計期間 | 今月 / 配信開始から | 今月 |
| テーマ | ダーク / ライト | ダーク |
| レイアウト | グリッド / 横並び / 縦並び | グリッド |
| クロマキー背景 | なし / グリーン / ブルー | なし |

### レイアウト別推奨用途

| レイアウト | 特徴 | 推奨配置 |
|-----------|------|---------|
| グリッド | 自動折り返し | 画面コーナー |
| 横並び | 固定幅カード横一列 | 画面上部/下部 |
| 縦並び | 固定幅カード縦一列 | 画面左右端 |

---

## 統計期間

### 今月（monthly）

当月1日〜現在までの統計。

### 配信開始から（session）

ポップアップ起動時刻以降の対戦のみを集計。

APIリクエスト時に`from_timestamp`パラメータとしてポップアップ起動時刻を渡すことで、セッション統計を取得する。

---

## クロマキー対応

| 背景 | CSS | 用途 |
|------|-----|------|
| なし | `transparent` | 直接表示 |
| グリーン | `#00FF00` | グリーンバック合成 |
| ブルー | `#0000FF` | ブルーバック合成 |

---

## URL構造

```
/streamer-popup?items=win_rate,total_duels&game_mode=RANK&stats_period=monthly&theme=dark&layout=horizontal&refresh=30000
```

| パラメータ | 説明 |
|-----------|------|
| items | 表示項目（カンマ区切り） |
| game_mode | ゲームモード |
| stats_period | 統計期間 |
| theme | テーマ |
| layout | レイアウト |
| refresh | 更新間隔（ms） |
| from_timestamp | セッション統計の基準時刻 |

---

## 設定の永続化

### ローカルストレージキー

```
duellog.streamerPopupSettings
```

### 保存形式

| フィールド | 型 | 説明 |
|-----------|-----|------|
| displayItems | 配列 | 表示項目（key, selected） |
| gameMode | string | 選択中のゲームモード |
| statsPeriod | string | 統計期間 |
| theme | string | テーマ（dark/light） |
| layout | string | レイアウト種別 |

---

## 使用方法

1. ダッシュボードの「配信者ポップアップ」セクションを開く
2. 表示項目・テーマ・レイアウトを設定
3. 「ポップアップを開く」でウィンドウを表示
4. OBSで「ウィンドウキャプチャ」を追加
5. ポップアップウィンドウを選択
6. 必要に応じてクロマキーフィルタを適用

---

## セキュリティ

| 観点 | 対策 |
|------|------|
| 認証 | 通常ログイン必須（トークン不要） |
| データアクセス | 自分の統計のみ取得可能 |
| URL漏洩 | トークンなしのためリスクなし |
| クロスオリジン | 同一オリジンのみ |

---

## 関連ドキュメント

| ドキュメント | 内容 |
|------------|------|
| [統計分析](./statistics.md) | 統計分析 |
| [API仕様](../../03-details/api.md) | API仕様 |
