# ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šã‚¨ãƒ©ãƒ¼ã®ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

## ğŸ”´ ã‚¨ãƒ©ãƒ¼å†…å®¹

```
psycopg2.OperationalError: connection to server at "db" (172.18.0.2), port 5432 failed: Connection refused
```

## ğŸ” åŸå› 

ã“ã®ã‚¨ãƒ©ãƒ¼ã¯ä»¥ä¸‹ã®ã„ãšã‚Œã‹ãŒåŸå› ã§ã™ï¼š

1. **ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚³ãƒ³ãƒ†ãƒŠãŒèµ·å‹•ã—ã¦ã„ãªã„**
2. **ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®æº–å‚™ãŒå®Œäº†ã™ã‚‹å‰ã«ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãŒæ¥ç¶šã‚’è©¦ã¿ãŸ**
3. **ç’°å¢ƒå¤‰æ•°ãŒæ­£ã—ãè¨­å®šã•ã‚Œã¦ã„ãªã„**
4. **ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯è¨­å®šã®å•é¡Œ**

## âœ… ä¿®æ­£å†…å®¹

### 1. `docker-compose.yml`ã®ä¿®æ­£

ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ã‚’è¿½åŠ ã—ã€ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãŒç¢ºå®Ÿã«ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®æº–å‚™å®Œäº†ã‚’å¾…ã¤ã‚ˆã†ã«ã—ã¾ã—ãŸã€‚

**å¤‰æ›´ç‚¹:**
```yaml
db:
  healthcheck:
    test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER}"]
    interval: 5s
    timeout: 5s
    retries: 5

backend:
  depends_on:
    db:
      condition: service_healthy  # â† ã“ã‚ŒãŒé‡è¦ï¼
  restart: on-failure
```

### 2. `backend/Dockerfile`ã®ä¿®æ­£

ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šå¾…æ©Ÿã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’è¿½åŠ ã—ã¾ã—ãŸã€‚

### 3. `backend/wait-for-db.sh`ã®ä½œæˆ

ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãŒå®Œå…¨ã«èµ·å‹•ã™ã‚‹ã¾ã§å¾…æ©Ÿã™ã‚‹å°‚ç”¨ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ä½œæˆã—ã¾ã—ãŸã€‚

### 4. `app/core/config.py`ã®ä¿®æ­£

ç’°å¢ƒå¤‰æ•°ãƒã‚§ãƒƒã‚¯ã‚’ç·©å’Œã—ã€èµ·å‹•æ™‚ã«ã‚¨ãƒ©ãƒ¼ã§æ­¢ã¾ã‚‰ãªã„ã‚ˆã†ã«ã—ã¾ã—ãŸã€‚

## ğŸš€ å†èµ·å‹•æ‰‹é †

### æ–¹æ³•1: å®Œå…¨ãªå†ãƒ“ãƒ«ãƒ‰ï¼ˆæ¨å¥¨ï¼‰

```bash
# æ—¢å­˜ã®ã‚³ãƒ³ãƒ†ãƒŠã¨ãƒœãƒªãƒ¥ãƒ¼ãƒ ã‚’å‰Šé™¤
docker-compose down -v

# ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’å†ãƒ“ãƒ«ãƒ‰
docker-compose build --no-cache

# ã‚³ãƒ³ãƒ†ãƒŠã‚’èµ·å‹•
docker-compose up
```

### æ–¹æ³•2: ã‚¯ã‚¤ãƒƒã‚¯å†èµ·å‹•

```bash
# ã‚³ãƒ³ãƒ†ãƒŠã‚’åœæ­¢
docker-compose down

# ã‚³ãƒ³ãƒ†ãƒŠã‚’èµ·å‹•
docker-compose up --build
```

## ğŸ”§ ç’°å¢ƒå¤‰æ•°ã®è¨­å®š

`.env`ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¦ä»¥ä¸‹ã‚’è¨­å®šã—ã¦ãã ã•ã„ï¼š

```bash
# ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­å®š
POSTGRES_USER=duellog_user
POSTGRES_PASSWORD=duellog_password
POSTGRES_DB=duellog_db
DATABASE_URL=postgresql://duellog_user:duellog_password@db:5432/duellog_db

# JWTè¨­å®š
SECRET_KEY=$(openssl rand -hex 32)
ALGORITHM=HS256
ACCESS_TOKEN_EXPIRE_MINUTES=30

# ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰è¨­å®š
VITE_API_BASE_URL=http://localhost:8000
```

**SECRET_KEYã®ç”Ÿæˆ:**
```bash
# Windowsã®å ´åˆï¼ˆGit Bashä½¿ç”¨ï¼‰
openssl rand -hex 32

# ã¾ãŸã¯ã€Pythonã§ç”Ÿæˆ
python -c "import secrets; print(secrets.token_hex(32))"
```

## ğŸ“ èµ·å‹•ãƒ­ã‚°ã®ç¢ºèª

æ­£å¸¸ã«èµ·å‹•ã™ã‚‹ã¨ã€ä»¥ä¸‹ã®ã‚ˆã†ãªãƒ­ã‚°ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ï¼š

```
duellog_db       | PostgreSQL init process complete; ready for start up.
duellog_db       | database system is ready to accept connections
duellog_backend  | â³ Waiting for database at db...
duellog_backend  | âœ… Database is ready!
duellog_backend  | ğŸ”„ Running Alembic migrations...
duellog_backend  | âœ… Migrations completed successfully!
duellog_backend  | ğŸš€ Starting Uvicorn server...
duellog_backend  | INFO:     Uvicorn running on http://0.0.0.0:8000
```

## ğŸ› ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### ã‚¨ãƒ©ãƒ¼1: ã€ŒSECRET_KEY is not setã€

**åŸå› :** `.env`ãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã—ãªã„ã‹ã€SECRET_KEYãŒè¨­å®šã•ã‚Œã¦ã„ãªã„

**è§£æ±ºæ–¹æ³•:**
```bash
# .envãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ
cp .env.example .env

# SECRET_KEYã‚’ç”Ÿæˆã—ã¦è¨­å®š
echo "SECRET_KEY=$(openssl rand -hex 32)" >> .env
```

### ã‚¨ãƒ©ãƒ¼2: ã€Œdatabase "duellog_db" does not existã€

**åŸå› :** ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãŒä½œæˆã•ã‚Œã¦ã„ãªã„

**è§£æ±ºæ–¹æ³•:**
```bash
# ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒœãƒªãƒ¥ãƒ¼ãƒ ã‚’å‰Šé™¤ã—ã¦å†ä½œæˆ
docker-compose down -v
docker-compose up
```

### ã‚¨ãƒ©ãƒ¼3: ãƒãƒ¼ãƒˆ5432ãŒæ—¢ã«ä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹

**åŸå› :** ãƒ­ãƒ¼ã‚«ãƒ«ã®PostgreSQLãŒæ—¢ã«èµ·å‹•ã—ã¦ã„ã‚‹

**è§£æ±ºæ–¹æ³•:**
```bash
# Windowsã®å ´åˆ
# ã‚µãƒ¼ãƒ“ã‚¹ã§PostgreSQLã‚’åœæ­¢

# ã¾ãŸã¯ã€docker-compose.ymlã§ãƒãƒ¼ãƒˆã‚’å¤‰æ›´
ports:
  - "5433:5432"  # ãƒ›ã‚¹ãƒˆå´ã‚’5433ã«å¤‰æ›´
```

### ã‚¨ãƒ©ãƒ¼4: ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼

**åŸå› :** Alembicã®ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã«å•é¡ŒãŒã‚ã‚‹

**è§£æ±ºæ–¹æ³•:**
```bash
# ã‚³ãƒ³ãƒ†ãƒŠã«å…¥ã‚‹
docker exec -it duellog_backend bash

# ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³çŠ¶æ…‹ã‚’ç¢ºèª
alembic current

# ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’æ‰‹å‹•å®Ÿè¡Œ
alembic upgrade head

# å•é¡ŒãŒã‚ã‚‹å ´åˆã¯ãƒ€ã‚¦ãƒ³ã‚°ãƒ¬ãƒ¼ãƒ‰
alembic downgrade -1
alembic upgrade head
```

## ğŸ” ãƒ­ã‚°ã®ç¢ºèªæ–¹æ³•

```bash
# å…¨ã¦ã®ãƒ­ã‚°ã‚’è¡¨ç¤º
docker-compose logs

# ç‰¹å®šã®ã‚µãƒ¼ãƒ“ã‚¹ã®ãƒ­ã‚°ã®ã¿è¡¨ç¤º
docker-compose logs backend
docker-compose logs db

# ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§ãƒ­ã‚°ã‚’è¿½è·¡
docker-compose logs -f backend
```

## âœ… å‹•ä½œç¢ºèª

èµ·å‹•ãŒæˆåŠŸã—ãŸã‚‰ã€ä»¥ä¸‹ã§å‹•ä½œç¢ºèªã—ã¦ãã ã•ã„ï¼š

```bash
# ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯
curl http://localhost:8000/

# æœŸå¾…ã•ã‚Œã‚‹ãƒ¬ã‚¹ãƒãƒ³ã‚¹:
# {"message":"Hello Duel Log"}

# APIãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ
# ãƒ–ãƒ©ã‚¦ã‚¶ã§ http://localhost:8000/docs ã‚’é–‹ã
```

## ğŸ“ ãã‚Œã§ã‚‚è§£æ±ºã—ãªã„å ´åˆ

ä»¥ä¸‹ã®æƒ…å ±ã‚’æä¾›ã—ã¦ãã ã•ã„ï¼š

1. **Dockerã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³**
   ```bash
   docker --version
   docker-compose --version
   ```

2. **å®Œå…¨ãªã‚¨ãƒ©ãƒ¼ãƒ­ã‚°**
   ```bash
   docker-compose logs > error-log.txt
   ```

3. **ç’°å¢ƒå¤‰æ•°ã®ç¢ºèª**ï¼ˆãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯ä¼ã›ã‚‹ï¼‰
   ```bash
   docker-compose config
   ```

4. **ã‚³ãƒ³ãƒ†ãƒŠã®çŠ¶æ…‹**
   ```bash
   docker-compose ps
   ```
