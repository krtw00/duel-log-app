# データベース接続エラーのトラブルシューティング

## 🔴 エラー内容

```
psycopg2.OperationalError: connection to server at "db" (172.18.0.2), port 5432 failed: Connection refused
```

## 🔍 原因

このエラーは以下のいずれかが原因です：

1. **データベースコンテナが起動していない**
2. **データベースの準備が完了する前にバックエンドが接続を試みた**
3. **環境変数が正しく設定されていない**
4. **ネットワーク設定の問題**

## ✅ 修正内容

### 1. `docker-compose.yml`の修正

データベースのヘルスチェックを追加し、バックエンドが確実にデータベースの準備完了を待つようにしました。

**変更点:**
```yaml
db:
  healthcheck:
    test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER}"]
    interval: 5s
    timeout: 5s
    retries: 5

backend:
  depends_on:
    db:
      condition: service_healthy  # ← これが重要！
  restart: on-failure
```

### 2. `backend/Dockerfile`の修正

データベース接続待機スクリプトを追加しました。

### 3. `backend/wait-for-db.sh`の作成

データベースが完全に起動するまで待機する専用スクリプトを作成しました。

### 4. `app/core/config.py`の修正

環境変数チェックを緩和し、起動時にエラーで止まらないようにしました。

## 🚀 再起動手順

### 方法1: 完全な再ビルド（推奨）

```bash
# 既存のコンテナとボリュームを削除
docker-compose down -v

# イメージを再ビルド
docker-compose build --no-cache

# コンテナを起動
docker-compose up
```

### 方法2: クイック再起動

```bash
# コンテナを停止
docker-compose down

# コンテナを起動
docker-compose up --build
```

## 🔧 環境変数の設定

`.env`ファイルを作成して以下を設定してください：

```bash
# データベース設定
POSTGRES_USER=duellog_user
POSTGRES_PASSWORD=duellog_password
POSTGRES_DB=duellog_db
DATABASE_URL=postgresql://duellog_user:duellog_password@db:5432/duellog_db

# JWT設定
SECRET_KEY=$(openssl rand -hex 32)
ALGORITHM=HS256
ACCESS_TOKEN_EXPIRE_MINUTES=30

# フロントエンド設定
VITE_API_BASE_URL=http://localhost:8000
```

**SECRET_KEYの生成:**
```bash
# Windowsの場合（Git Bash使用）
openssl rand -hex 32

# または、Pythonで生成
python -c "import secrets; print(secrets.token_hex(32))"
```

## 📝 起動ログの確認

正常に起動すると、以下のようなログが表示されます：

```
duellog_db       | PostgreSQL init process complete; ready for start up.
duellog_db       | database system is ready to accept connections
duellog_backend  | ⏳ Waiting for database at db...
duellog_backend  | ✅ Database is ready!
duellog_backend  | 🔄 Running Alembic migrations...
duellog_backend  | ✅ Migrations completed successfully!
duellog_backend  | 🚀 Starting Uvicorn server...
duellog_backend  | INFO:     Uvicorn running on http://0.0.0.0:8000
```

## 🐛 トラブルシューティング

### エラー1: 「SECRET_KEY is not set」

**原因:** `.env`ファイルが存在しないか、SECRET_KEYが設定されていない

**解決方法:**
```bash
# .envファイルを作成
cp .env.example .env

# SECRET_KEYを生成して設定
echo "SECRET_KEY=$(openssl rand -hex 32)" >> .env
```

### エラー2: 「database "duellog_db" does not exist」

**原因:** データベースが作成されていない

**解決方法:**
```bash
# データベースボリュームを削除して再作成
docker-compose down -v
docker-compose up
```

### エラー3: ポート5432が既に使用されている

**原因:** ローカルのPostgreSQLが既に起動している

**解決方法:**
```bash
# Windowsの場合
# サービスでPostgreSQLを停止

# または、docker-compose.ymlでポートを変更
ports:
  - "5433:5432"  # ホスト側を5433に変更
```

### エラー4: マイグレーションエラー

**原因:** Alembicのマイグレーションファイルに問題がある

**解決方法:**
```bash
# コンテナに入る
docker exec -it duellog_backend bash

# マイグレーション状態を確認
alembic current

# マイグレーションを手動実行
alembic upgrade head

# 問題がある場合はダウングレード
alembic downgrade -1
alembic upgrade head
```

## 🔍 ログの確認方法

```bash
# 全てのログを表示
docker-compose logs

# 特定のサービスのログのみ表示
docker-compose logs backend
docker-compose logs db

# リアルタイムでログを追跡
docker-compose logs -f backend
```

## ✅ 動作確認

起動が成功したら、以下で動作確認してください：

```bash
# ヘルスチェック
curl http://localhost:8000/

# 期待されるレスポンス:
# {"message":"Hello Duel Log"}

# APIドキュメント
# ブラウザで http://localhost:8000/docs を開く
```

## 📞 それでも解決しない場合

以下の情報を提供してください：

1. **Dockerのバージョン**
   ```bash
   docker --version
   docker-compose --version
   ```

2. **完全なエラーログ**
   ```bash
   docker-compose logs > error-log.txt
   ```

3. **環境変数の確認**（パスワードは伏せる）
   ```bash
   docker-compose config
   ```

4. **コンテナの状態**
   ```bash
   docker-compose ps
   ```
