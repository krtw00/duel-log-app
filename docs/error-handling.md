# エラーハンドリング設計

このドキュメントは、Duel Log Appにおけるエラーハンドリングの設計方針について記述します。

---

## 概要

堅牢なアプリケーションを構築するため、バックエンドとフロントエンドで一貫したエラーハンドリング戦略を採用します。エラーは適切に捕捉・分類され、開発者には詳細なログを、ユーザーには分かりやすいフィードバックを提供することを目指します。

---

## バックエンド (FastAPI)

バックエンドでは、`app/core/exception_handlers.py` にてグローバルな例外ハンドラを定義し、エラーの種類に応じて異なるHTTPレスポンスを返します。

### 1. バリデーションエラー (`422 Unprocessable Entity`)

- **トリガー**: Pydanticのスキーマバリデーションに失敗した場合（例: 必須項目がない、データ型が違う）。
- **ハンドラ**: `validation_exception_handler`
- **処理**: 
  - どのフィールドでどのようなエラーが発生したかの詳細を含むJSONを返します。
  - ログレベル: `WARNING`
- **レスポンス例**:
  ```json
  {
    "message": "入力値が不正です",
    "detail": [
      {
        "loc": ["body", "email"],
        "msg": "value is not a valid email address",
        "type": "value_error.email"
      }
    ]
  }
  ```

### 2. 認証・認可エラー (`401 Unauthorized`, `403 Forbidden`)

- **トリガー**: 
  - 認証トークンがない、または無効な場合 (`401`)。
  - ユーザーが必要な権限を持っていない場合 (`403`)。
- **ハンドラ**: `app_exception_handler` (カスタム例外`AppException`を捕捉)
- **処理**: 
  - エラーメッセージを含むJSONを返します。
  - ログレベル: `ERROR`
- **レスポンス例 (401)**:
  ```json
  {
    "message": "認証が必要です",
    "detail": "認証トークンが無効です"
  }
  ```

### 3. データベースエラー (`500 Internal Server Error`)

- **トリガー**: SQLAlchemyが発行する例外（例: 接続エラー、クエリ構文エラー）。
- **ハンドラ**: `sqlalchemy_exception_handler`
- **処理**: 
  - ユーザーには汎用的なエラーメッセージを返します。
  - 開発者向けに、スタックトレースを含む詳細なエラーログを記録します。
  - ログレベル: `ERROR`
- **レスポンス例**:
  ```json
  {
    "message": "データベースエラーが発生しました",
    "detail": "サーバー内部エラー"
  }
  ```

### 4. その他のサーバーエラー (`500 Internal Server Error`)

- **トリガー**: 上記以外で捕捉されなかった予期せぬ例外。
- **ハンドラ**: `general_exception_handler`
- **処理**: 
  - ユーザーには汎用的なエラーメッセージを返します。
  - 開発者向けに、スタックトレースを含む詳細なエラーログを記録します。
  - ログレベル: `ERROR`
- **レスポンス例**:
  ```json
  {
    "message": "予期しないエラーが発生しました",
    "detail": "サーバー内部エラー"
  }
  ```

---

## フロントエンド (Vue.js)

フロントエンドでは、ユーザー体験を損なわないように、エラーをグローバルかつ局所的にハンドリングします。

### 1. グローバルなAPIエラーハンドリング

`src/services/api.ts` のAxiosインターセプターで、バックエンドからのすべてのAPIレスポンスを監視します。

- **`401 Unauthorized`**: 
  - 認証トークンが無効、または期限切れと判断します。
  - `authStore`のユーザー情報をクリアし、自動的にログインページ (`/login`) にリダイレクトさせます。
- **`403 Forbidden`**: 
  - 権限がない操作を行おうとした場合に発生します。
  - 「この操作を行う権限がありません」といったメッセージをトースト通知で表示します。
- **`422 Unprocessable Entity`**: 
  - フォームの入力値などがバリデーションに失敗した場合に発生します。
  - 各フォームコンポーネントが個別に処理するため、グローバルでは何もしません。
- **`5xx` サーバーエラー**: 
  - 「サーバーエラーが発生しました。時間をおいて再度お試しください」といったメッセージをトースト通知で表示します。

### 2. フォームにおけるバリデーションエラー

- 各入力フォームでは、バックエンドから`422`エラーが返された場合、レスポンスボディの`detail`フィールドを解析します。
- どのフィールドでどのようなエラーが発生したかを、Vuetifyのコンポーネントのエラーメッセージとして表示し、ユーザーに修正を促します。

### 3. グローバルな通知システム

- **`stores/notification.ts`**: Piniaストアでトースト通知の状態を管理します。
- **`components/common/ToastNotification.vue`**: 上記ストアを監視し、メッセージがセットされたら画面下部にトーストを自動的に表示します。成功（緑）、エラー（赤）、情報（青）など、種別に応じた色分けを行います。

### 4. ローディング管理

- **`stores/loading.ts`**: Piniaストアでグローバルなローディング状態を管理します。
- **`components/common/LoadingOverlay.vue`**: 上記ストアを監視し、APIリクエスト中など、時間のかかる処理中に画面全体を覆うローディングオーバーレイを表示します。
