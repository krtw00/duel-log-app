# パスワード認証エラーの解決ガイド

## エラー内容

```
FATAL: password authentication failed for user "duellog_user"
```

## 原因

データベースは起動しているが、以下の理由で認証に失敗：

1. `.env`ファイルのパスワードとデータベースコンテナの設定が不一致
2. 古いデータベースボリュームが残っており、異なるパスワードで作成されている
3. `.env`ファイルが存在しない、または正しく読み込まれていない

## 解決手順

### ステップ1: 完全クリーンアップ

```bash
# すべてのコンテナとボリュームを削除
docker-compose down -v

# 孤立したボリュームも削除
docker volume prune -f

# イメージもクリーンアップ（オプション）
docker-compose down --rmi all
```

### ステップ2: .envファイルの確認・作成

プロジェクトルート（docker-compose.ymlと同じ場所）に`.env`ファイルを作成：

```bash
# 既存の.envファイルを確認
cat .env

# または、新規作成
nano .env
```

**正しい.envファイルの内容:**

```env
# Database Configuration
POSTGRES_USER=duelloguser
POSTGRES_PASSWORD=duellogpassword123
POSTGRES_DB=duellogdb
DATABASE_URL=postgresql://duelloguser:duellogpassword123@db:5432/duellogdb

# JWT Configuration  
SECRET_KEY=your-64-character-random-secret-key-here-please-change-this
ALGORITHM=HS256
ACCESS_TOKEN_EXPIRE_MINUTES=30

# Frontend Configuration
VITE_API_BASE_URL=http://localhost:8000
```

**重要:** 
- `POSTGRES_USER`, `POSTGRES_PASSWORD`, `POSTGRES_DB`は同じ値を`DATABASE_URL`にも使用
- パスワードに特殊文字（`@`, `:`, `/`など）は避ける

### ステップ3: SECRET_KEYの生成

```bash
# Git Bash (Windows) または Linux/Mac
openssl rand -hex 32

# または Python
python -c "import secrets; print(secrets.token_hex(32))"
```

生成された文字列を`.env`の`SECRET_KEY=`に設定します。

### ステップ4: 権限の確認（Linux/Mac）

```bash
# .envファイルの権限を確認
ls -la .env

# 必要に応じて権限を設定
chmod 600 .env
```

### ステップ5: docker-compose.ymlの確認

`env_file`が正しく設定されているか確認：

```yaml
backend:
  env_file:
    - .env  # ← これが正しい位置にあるか確認
```

### ステップ6: 再ビルドと起動

```bash
# イメージを再ビルド
docker-compose build --no-cache

# 起動（フォアグラウンド）
docker-compose up

# または、バックグラウンドで起動
docker-compose up -d

# ログを確認
docker-compose logs -f backend
```

## 確認ポイント

### 1. 環境変数が正しく読み込まれているか確認

```bash
# バックエンドコンテナで環境変数を確認
docker exec duellog_backend env | grep POSTGRES

# 期待される出力:
# POSTGRES_USER=duelloguser
# POSTGRES_PASSWORD=duellogpassword123
# POSTGRES_DB=duellogdb
```

### 2. データベースコンテナで環境変数を確認

```bash
# データベースコンテナで環境変数を確認
docker exec duellog_db env | grep POSTGRES

# 同じ値が表示されるはず
```

### 3. 手動でデータベース接続テスト

```bash
# データベースコンテナに入って手動接続
docker exec -it duellog_db psql -U duelloguser -d duellogdb

# パスワードを入力（.envで設定した値）
# 接続成功すれば psql プロンプトが表示される
```

## よくある問題

### 問題1: .envファイルが読み込まれない

**症状:**
```bash
docker exec duellog_backend env | grep POSTGRES
# 何も表示されない
```

**解決:**
- `.env`ファイルが`docker-compose.yml`と同じディレクトリにあるか確認
- ファイル名が`.env`（先頭にドット）か確認
- Windowsの場合、隠しファイルを表示する設定を確認

### 問題2: パスワードに特殊文字が含まれている

**症状:**
パスワードに`@`や`:`などが含まれていると、`DATABASE_URL`のパースに失敗

**解決:**
パスワードをシンプルな英数字のみに変更：
```env
POSTGRES_PASSWORD=simplepassword123
```

### 問題3: ボリュームが完全に削除されていない

**症状:**
`docker-compose down -v`を実行しても古い設定が残る

**解決:**
```bash
# ボリューム名を確認
docker volume ls

# 手動で削除
docker volume rm duel-log-app_db_data

# または、すべてのボリュームを削除（注意！）
docker volume prune -a
```

### 問題4: Windowsの改行コード問題

**症状:**
`.env`ファイルがWindows形式（CRLF）で保存されている

**解決:**
```bash
# Git Bashで改行コードを確認
file .env

# LF（Unix形式）に変換
dos2unix .env

# または、エディタで「LF」として保存
```

## デバッグコマンド

```bash
# 1. コンテナの状態を確認
docker-compose ps

# 2. 環境変数を確認
docker-compose config

# 3. バックエンドのログを確認
docker-compose logs backend | grep -i password

# 4. データベースのログを確認
docker-compose logs db | tail -50

# 5. ネットワークを確認
docker network inspect duel-log-app_duellog_network
```

## 完全なリセット手順（最終手段）

すべてがうまくいかない場合：

```bash
# 1. すべて停止・削除
docker-compose down -v --rmi all

# 2. Dockerのキャッシュをクリア
docker system prune -a --volumes

# 3. .envファイルを再作成
rm .env
cp .env.example .env
# .envファイルを編集して正しい値を設定

# 4. 再ビルド
docker-compose build --no-cache

# 5. 起動
docker-compose up
```

## 成功時のログ

正常に起動すると以下のようなログが表示されます：

```
duellog_db       | PostgreSQL init process complete; ready for start up
duellog_db       | LOG: database system is ready to accept connections
duellog_backend  | ⏳ Waiting for database at db...
duellog_backend  | ✅ Database is ready!
duellog_backend  | 🔄 Running Alembic migrations...
duellog_backend  | INFO [alembic.runtime.migration] Context impl PostgresqlImpl.
duellog_backend  | INFO [alembic.runtime.migration] Will assume transactional DDL.
duellog_backend  | ✅ Migrations completed successfully!
duellog_backend  | 🚀 Starting Uvicorn server...
duellog_backend  | INFO: Uvicorn running on http://0.0.0.0:8000
```

## まだ解決しない場合

以下の情報を提供してください：

1. `.env`ファイルの内容（パスワードは`***`で隠す）
2. `docker-compose config`の出力
3. `docker-compose logs db`の出力
4. `docker-compose logs backend`の出力
5. 使用しているOS（Windows/Mac/Linux）
