# コード可読性向上ロードマップ

## 概要

このロードマップは、Duel Log Appのコードベースを人間による編集・査読に適したものにするための、段階的な改善計画です。

**目標:** 可読性スコア 7/10 → 9/10 への向上
**期間:** 3週間（フルタイム換算：約40-60時間）
**優先戦略:** 高影響・複雑な箇所から着手

---

## 📊 現状分析（ベースライン）

| 指標 | 現在 | 目標 | GAP |
|------|------|------|-----|
| 関数ドキュメント | 6/10 | 9/10 | +3 |
| インラインコメント | 4/10 | 8/10 | +4 |
| コード重複 | 7/10 | 9/10 | +2 |
| 命名の明確性 | 8/10 | 9/10 | +1 |
| 総合可読性 | 7/10 | 9/10 | +2 |

---

## 🎯 Phase 1: 緊急対応（第1週）

**目標:** 複雑で理解が困難な箇所のドキュメント化
**工数見積:** 12-16時間
**担当:** コアメンバー

### タスク一覧

#### 1.1 バックエンドサービスのdocstring追加（8時間）

| ファイル | 行数 | 複雑度 | 工数 | 優先度 |
|---------|------|--------|------|--------|
| `matchup_service.py` | 167 | 高 | ✅ 完了 | P0 |
| `general_stats_service.py` | 110 | 高 | 2h | P0 |
| `deck_distribution_service.py` | 95 | 中 | 1.5h | P1 |
| `time_series_service.py` | 88 | 中 | 1.5h | P1 |
| `deck_service.py` | 220 | 中 | 2h | P1 |

**成果物:**
- 各関数に詳細なdocstring（Args, Returns, 処理フロー）
- 複雑なロジックへのインラインコメント（各ファイル5-10箇所）

**テンプレート:** `docs/code-readability-guide.md` の「改善例」を参照

---

#### 1.2 フロントエンド主要ビューのドキュメント化（4時間）

| ファイル | 行数 | 複雑度 | 工数 | 優先度 |
|---------|------|--------|------|--------|
| `StatisticsView.vue` | 520 | 高 | ✅ 完了 | P0 |
| `DashboardView.vue` | 380 | 中 | 1.5h | P0 |
| `DuelFormDialog.vue` | 210 | 中 | 1h | P1 |
| `ProfileView.vue` | 150 | 低 | 0.5h | P2 |

**成果物:**
- ファイルレベルのコンポーネントドキュメント
- 複雑な状態管理ロジックへのコメント
- 算出プロパティの目的説明

---

#### 1.3 モデル定義の明確化（2時間）

| ファイル | タスク | 工数 |
|---------|--------|------|
| `backend/app/models/duel.py` | フィールドの説明コメント追加 | 1h |
| `backend/app/models/deck.py` | リレーションシップの説明追加 | 0.5h |
| `frontend/src/types/index.ts` | 型定義にコメント追加 | 0.5h |

**成果物:**
- 各フィールドの意味を明記（特に `first_or_second`, `coin`, `result`）
- リレーションシップの説明

---

### Phase 1 完了基準

- [ ] 5つ以上の複雑なサービス関数に詳細docstring追加
- [ ] 3つ以上の主要Vueコンポーネントにドキュメント追加
- [ ] モデル定義に全フィールドの説明追加
- [ ] コードレビュー通過（別メンバーによる）

**期待効果:** 可読性スコア 7/10 → 8/10

---

## 🚀 Phase 2: 重要改善（第2週）

**目標:** コード品質の向上と重複の削減
**工数見積:** 16-20時間
**担当:** 開発チーム全員

### タスク一覧

#### 2.1 クエリビルダーの共通化（4時間）

**ステップ:**

1. **`backend/app/utils/query_builders.py` 作成（1h）**
   ```python
   def build_duels_query_with_filters(...)
   def build_decks_query_with_filters(...)
   def apply_date_range_filter(...)
   ```

2. **サービスをリファクタリング（2h）**
   - `matchup_service.py`
   - `deck_distribution_service.py`
   - `time_series_service.py`
   - `general_stats_service.py`

3. **テスト追加（1h）**
   - `tests/utils/test_query_builders.py` 作成

**成果物:**
- 共通クエリビルダーモジュール
- 重複コード削減（推定: 80行削減）
- ユニットテスト（カバレッジ 80%以上）

---

#### 2.2 Composablesの詳細ドキュメント化（4時間）

| ファイル | タスク | 工数 |
|---------|--------|------|
| `useStatsCalculation.ts` | JSDoc + 使用例 | 1.5h |
| `useDuelFormValidation.ts` | JSDoc + バリデーションルール説明 | 1h |
| `useChartOptions.ts` | JSDoc + チャート設定説明 | 1h |
| `useAuth.ts` | JSDoc + 認証フロー説明 | 0.5h |

**成果物:**
- 各Composableに詳細JSDoc
- 使用例コード
- パラメータ/戻り値の完全な型情報

---

#### 2.3 命名規則の統一計画策定（8時間）

**ステップ:**

1. **曖昧な命名のリストアップ（2h）**
   - データベースカラム名
   - API フィールド名
   - フロントエンド変数名

2. **マイグレーション計画作成（3h）**
   ```
   現在           → 改善後
   ────────────────────────────────
   first_or_second → is_going_first
   coin            → won_coin_toss
   result          → is_win
   opponentDeck_id → opponent_deck_id
   ```

3. **影響範囲調査（2h）**
   - データベース移行スクリプト
   - バックエンドコード変更箇所
   - フロントエンドコード変更箇所
   - テストコード変更箇所

4. **移行手順書作成（1h）**
   - ダウンタイムなし移行戦略
   - ロールバック手順

**成果物:**
- 命名規則統一計画書
- Alembicマイグレーションスクリプト（ドラフト）
- 影響範囲分析レポート

**注意:** 実際の実装はPhase 3以降に実施（データベース変更のため慎重に）

---

### Phase 2 完了基準

- [ ] クエリビルダーユーティリティ実装・テスト完了
- [ ] 4つ以上のComposablesに詳細JSDoc追加
- [ ] 命名規則統一計画書完成
- [ ] コードレビュー通過
- [ ] リグレッションテスト通過

**期待効果:** 可読性スコア 8/10 → 8.5/10

---

## 🎨 Phase 3: 拡張改善（第3週）

**目標:** 長期的な保守性向上
**工数見積:** 12-16時間
**担当:** 開発チーム全員

### タスク一覧

#### 3.1 テストコードのドキュメント化（4時間）

| ファイル | タスク | 工数 |
|---------|--------|------|
| `test_statistics_api.py` | モジュールdocstring + テストケース説明 | 1.5h |
| `test_deck_service.py` | モジュールdocstring + テストケース説明 | 1h |
| `test_auth.py` | モジュールdocstring + 認証フロー説明 | 1h |
| その他テストファイル | 簡潔な説明追加 | 0.5h |

**テンプレート:**
```python
"""
test_statistics_api.py

統計APIエンドポイントのテスト

テスト対象:
- GET /api/statistics/ - 統計情報取得
  - 正常系: ...
  - 異常系: ...
  - フィルター: ...
"""

def test_get_statistics(...):
    """
    正常系: 認証済みユーザーが自分の統計を取得できることを確認

    前提条件:
    - ...

    期待結果:
    - ...
    """
```

---

#### 3.2 API契約の文書化（3時間）

**タスク:**

1. **`frontend/src/services/api.ts` にコメント追加（1h）**
   - 認証方式の説明
   - エラーレスポンス構造
   - インターセプター動作

2. **API エンドポイント一覧更新（1h）**
   - `docs/api-reference.md` の更新
   - リクエスト/レスポンス例の追加

3. **OpenAPI (Swagger) 仕様の充実（1h）**
   - FastAPI の schema description 追加
   - 各エンドポイントに examples 追加

**成果物:**
- 完全なAPI契約ドキュメント
- フロントエンド開発者が参照しやすい形式

---

#### 3.3 状態管理の可視化（3時間）

| ファイル | タスク | 工数 |
|---------|--------|------|
| `stores/auth.ts` | 状態遷移図 + 詳細コメント | 1h |
| `stores/decks.ts` | データフロー図 + 詳細コメント | 1h |
| `stores/duels.ts` | データフロー図 + 詳細コメント | 0.5h |
| `stores/statistics.ts` | データフロー図 + 詳細コメント | 0.5h |

**テンプレート:**
```typescript
/**
 * authStore - 認証状態管理
 *
 * 状態遷移:
 * ┌──────────────┐
 * │ 未認証       │
 * │ (初期状態)   │
 * └──────┬───────┘
 *        │ login()
 *        ↓
 * ┌──────────────┐
 * │ 認証済み     │
 * ...
 */
```

---

#### 3.4 コーディング規約のリンター強化（2時間）

**設定追加:**

1. **Pythonリンター（Ruff）強化**
   ```toml
   [tool.ruff]
   select = [
     "D",   # pydocstyle (docstring規約)
   ]
   [tool.ruff.pydocstyle]
   convention = "google"
   ```

2. **TypeScriptリンター（ESLint）強化**
   ```json
   {
     "plugins": ["jsdoc"],
     "rules": {
       "jsdoc/require-jsdoc": "warn",
       "jsdoc/require-param": "warn",
       "jsdoc/require-returns": "warn"
     }
   }
   ```

3. **pre-commit hook 設定**
   - ドキュメントチェックを自動化

---

### Phase 3 完了基準

- [ ] 全テストファイルにドキュメント追加
- [ ] API契約ドキュメント完成
- [ ] 全Piniaストアに状態遷移図追加
- [ ] リンター設定強化
- [ ] チーム全体でのコードレビュー会実施

**期待効果:** 可読性スコア 8.5/10 → 9/10

---

## 📈 継続的改善（Phase 4以降）

### 長期的な取り組み

#### 4.1 命名規則の統一実装（Phase 2で計画したものを実装）

**スケジュール:**
- **第4週:** データベースマイグレーション作成・テスト
- **第5週:** バックエンドコード更新
- **第6週:** フロントエンドコード更新
- **第7週:** リグレッションテスト・デプロイ

**注意事項:**
- 本番データに影響するため、慎重に実施
- ステージング環境で十分なテスト
- ロールバック手順を事前準備

---

#### 4.2 定期的なドキュメントレビュー

**頻度:** 月1回（スプリント終了時）

**レビュー項目:**
- 新規追加コードにドキュメントがあるか
- 既存ドキュメントが最新の実装と一致しているか
- コメントが古くなっていないか

**担当:** ローテーション制

---

#### 4.3 オンボーディング資料の整備

**新規メンバー向けガイド作成:**
- アーキテクチャ図
- データフロー図
- 開発環境セットアップガイド（既存）の充実
- よくあるトラブルシューティング

---

## 🛠️ 使用ツール

### ドキュメント生成

- **Python:** `pydoc`, `sphinx` (将来的に)
- **TypeScript:** `TypeDoc`, `JSDoc`

### コード品質チェック

- **Python:** Ruff (リンティング), Black (フォーマット), mypy (型チェック)
- **TypeScript:** ESLint, Prettier, TypeScript Compiler

### プロジェクト管理

- **GitHub Issues:** タスク管理
- **GitHub Projects:** 進捗可視化
- **GitHub Actions:** CI/CD（リンターチェック自動化）

---

## 📊 進捗管理

### KPI（測定指標）

| 指標 | 測定方法 | 目標 |
|------|---------|------|
| Docstring カバレッジ | Ruff pydocstyle チェック | 90%以上 |
| JSDoc カバレッジ | ESLint jsdoc プラグイン | 80%以上 |
| コード重複率 | SonarQube/CodeClimate | 5%以下 |
| コメント密度 | コメント行数 / コード行数 | 15-25% |
| コードレビュー時間 | PR マージまでの平均時間 | 30%短縮 |

### 進捗トラッキング

**GitHub Project ボード:**
```
┌─────────────┬─────────────┬─────────────┬──────────┐
│ To Do       │ In Progress │ Review      │ Done     │
├─────────────┼─────────────┼─────────────┼──────────┤
│ Phase 2     │ Phase 1     │ matchup_    │ Stats    │
│ タスク      │ タスク      │ service.py  │ View.vue │
│             │             │             │          │
└─────────────┴─────────────┴─────────────┴──────────┘
```

**週次レポート:**
- 完了したタスク
- 発見された課題
- 次週の計画

---

## 💡 ベストプラクティス

### 新規コード作成時

1. **関数作成前にdocstring/JSDocを書く**（TDD的アプローチ）
2. **複雑なロジックは疑似コードコメントから始める**
3. **命名で悩んだら、チームに相談**

### コードレビュー時

1. **ドキュメントの有無を必ずチェック**
2. **「なぜ」が説明されているかを確認**
3. **他の開発者が理解できるかの視点**

### リファクタリング時

1. **まずドキュメントを読む**
2. **理解できない箇所はコメント追加**
3. **リファクタリング後、ドキュメント更新**

---

## 🎯 成功基準

### Phase 1-3 完了時（3週間後）

- ✅ 可読性スコア 9/10 達成
- ✅ 新規メンバーのオンボーディング時間 50%短縮
- ✅ コードレビュー時間 30%短縮
- ✅ バグ発見率の向上（ドキュメントにより理解が深まるため）

### 6ヶ月後

- ✅ 技術的負債の削減（命名規則統一完了）
- ✅ ドキュメントカバレッジ 90%維持
- ✅ チーム全体のコード品質意識向上
- ✅ AIアシストからの完全移行（人間主導のコードレビュー体制）

---

## 📚 参考資料

- `docs/code-readability-guide.md` - 詳細なガイドライン
- `docs/development-guide.md` - 開発ワークフロー
- `CLAUDE.md` - プロジェクト概要

---

## 🤝 チームコミュニケーション

### 週次ミーティング

**議題:**
- 今週の進捗報告
- 困難だったタスクの共有
- ベストプラクティスの共有
- 次週の計画

### ドキュメントレビュー会（月1回）

**議題:**
- 追加されたドキュメントのレビュー
- わかりにくい箇所の改善
- チーム全体での知識共有

---

## 🚦 リスクと対策

| リスク | 影響 | 対策 |
|--------|------|------|
| 工数超過 | スケジュール遅延 | 優先度の低いタスクは Phase 4 に延期 |
| チームメンバーの負担 | モチベーション低下 | タスクを小分けにし、週単位で成果を実感 |
| 命名変更の影響範囲が大きい | バグ混入リスク | Phase 3 での慎重な計画と十分なテスト |
| ドキュメントが陳腐化 | メンテナンスコスト増 | リンターと pre-commit hook で自動チェック |

---

## ✅ 次のアクション

1. **今すぐ:** このロードマップをチームで共有
2. **今週中:** Phase 1 タスクを GitHub Issues に登録
3. **来週:** Phase 1 開始、週次進捗会議をスケジュール
4. **3週間後:** Phase 1-3 完了レビュー会を開催

---

**更新履歴:**
- 2025-10-28: 初版作成（現状分析とPhase 1-3計画）
- 2025-10-28: Phase 1-3 完了（ドキュメント化作業完了）
- 2025-10-29: リンター設定強化完了
  - Ruff pydocstyle (Google Style) 設定追加
  - ESLint JSDoc プラグイン設定追加
  - pre-commit hooks 設定追加
- 次回更新予定: Phase 4 開始時（命名規則統一）
