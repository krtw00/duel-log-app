name: PR Auto Review

on:
  pull_request:
    types: [opened, edited, synchronize, reopened]

jobs:
  review:
    name: Automated PR Review
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Check PR title format
        uses: amannn/action-semantic-pull-request@v5
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          types: |
            feat
            fix
            docs
            style
            refactor
            perf
            test
            build
            ci
            chore
            revert
          requireScope: false
          subjectPattern: ^(?![A-Z]).+$
          subjectPatternError: |
            The subject "{subject}" found in the pull request title "{title}"
            didn't match the configured pattern. Please ensure that the subject
            doesn't start with an uppercase character.

      - name: Check PR size
        run: |
          FILES_CHANGED=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | wc -l)
          LINES_CHANGED=$(git diff --stat origin/${{ github.base_ref }}...HEAD | tail -1 | awk '{print $4+$6}')

          echo "Files changed: $FILES_CHANGED"
          echo "Lines changed: $LINES_CHANGED"

          if [ "$FILES_CHANGED" -gt 50 ]; then
            echo "::warning::This PR changes more than 50 files. Consider splitting it into smaller PRs for easier review."
          fi

          if [ "$LINES_CHANGED" -gt 1000 ]; then
            echo "::warning::This PR changes more than 1000 lines. Consider splitting it into smaller PRs for easier review."
          fi

      - name: Check for TODO comments
        run: |
          TODO_COUNT=$(git diff origin/${{ github.base_ref }}...HEAD | grep -E "^\+.*TODO|^\+.*FIXME|^\+.*XXX" | wc -l || true)
          if [ "$TODO_COUNT" -gt 0 ]; then
            echo "::warning::Found $TODO_COUNT new TODO/FIXME/XXX comments in this PR"
          fi

      - name: Check for console.log in frontend
        run: |
          CONSOLE_COUNT=$(git diff origin/${{ github.base_ref }}...HEAD -- frontend/ | grep -E "^\+.*console\.(log|debug|info|warn|error)" | wc -l || true)
          if [ "$CONSOLE_COUNT" -gt 0 ]; then
            echo "::warning::Found $CONSOLE_COUNT new console.log statements in frontend code"
          fi

      - name: Check for print statements in backend
        run: |
          PRINT_COUNT=$(git diff origin/${{ github.base_ref }}...HEAD -- backend/ | grep -E "^\+.*print\(" | wc -l || true)
          if [ "$PRINT_COUNT" -gt 0 ]; then
            echo "::warning::Found $PRINT_COUNT new print() statements in backend code. Consider using proper logging."
          fi

      - name: Check for missing tests
        run: |
          # ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®å¤‰æ›´ã‚’ãƒã‚§ãƒƒã‚¯
          BACKEND_FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD -- backend/app/ | grep -v __pycache__ | wc -l || true)
          BACKEND_TEST_FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD -- backend/tests/ | wc -l || true)

          # ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®å¤‰æ›´ã‚’ãƒã‚§ãƒƒã‚¯
          FRONTEND_FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD -- frontend/src/ | grep -E '\.(ts|vue)$' | wc -l || true)
          FRONTEND_TEST_FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD -- frontend/ | grep -E '\.spec\.(ts|js)$|\.test\.(ts|js)$' | wc -l || true)

          if [ "$BACKEND_FILES" -gt 0 ] && [ "$BACKEND_TEST_FILES" -eq 0 ]; then
            echo "::warning::Backend code was modified but no test files were changed. Consider adding tests."
          fi

          if [ "$FRONTEND_FILES" -gt 0 ] && [ "$FRONTEND_TEST_FILES" -eq 0 ]; then
            echo "::warning::Frontend code was modified but no test files were changed. Consider adding tests."
          fi

      - name: Comment PR with review summary
        uses: actions/github-script@v7
        if: always()
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('Automated PR Review')
            );

            const body = `## ðŸ¤– Automated PR Review

            âœ… PR title format check completed
            âœ… PR size analysis completed
            âœ… Code quality checks completed

            Please review any warnings above and address them if necessary.

            *This is an automated review. Human review is still required.*`;

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }
