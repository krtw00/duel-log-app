name: PR Auto Review

on:
  pull_request:
    types: [opened, edited, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  review:
    name: Automated PR Review
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Check PR title format
        uses: amannn/action-semantic-pull-request@v5
        continue-on-error: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          types: |
            feat
            fix
            docs
            style
            refactor
            perf
            test
            build
            ci
            chore
            revert
          requireScope: false

      - name: Check PR size
        run: |
          FILES_CHANGED=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | wc -l)
          LINES_CHANGED=$(git diff --stat origin/${{ github.base_ref }}...HEAD | tail -1 | awk '{print $4+$6}')

          echo "å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«æ•°: $FILES_CHANGED"
          echo "å¤‰æ›´è¡Œæ•°: $LINES_CHANGED"

          if [ "$FILES_CHANGED" -gt 50 ]; then
            echo "::warning::ã“ã®PRã¯50å€‹ä»¥ä¸Šã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å¤‰æ›´ã—ã¦ã„ã¾ã™ã€‚ãƒ¬ãƒ“ãƒ¥ãƒ¼ã—ã‚„ã™ãã™ã‚‹ãŸã‚ã€è¤‡æ•°ã®PRã«åˆ†å‰²ã™ã‚‹ã“ã¨ã‚’æ¤œè¨ã—ã¦ãã ã•ã„ã€‚"
          fi

          if [ "$LINES_CHANGED" -gt 1000 ]; then
            echo "::warning::ã“ã®PRã¯1000è¡Œä»¥ä¸Šã‚’å¤‰æ›´ã—ã¦ã„ã¾ã™ã€‚ãƒ¬ãƒ“ãƒ¥ãƒ¼ã—ã‚„ã™ãã™ã‚‹ãŸã‚ã€è¤‡æ•°ã®PRã«åˆ†å‰²ã™ã‚‹ã“ã¨ã‚’æ¤œè¨ã—ã¦ãã ã•ã„ã€‚"
          fi

      - name: Check for TODO comments
        run: |
          TODO_COUNT=$(git diff origin/${{ github.base_ref }}...HEAD | grep -E "^\+.*TODO|^\+.*FIXME|^\+.*XXX" | wc -l || true)
          if [ "$TODO_COUNT" -gt 0 ]; then
            echo "::warning::ã“ã®PRã«${TODO_COUNT}å€‹ã®æ–°ã—ã„TODO/FIXME/XXXã‚³ãƒ¡ãƒ³ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ"
          fi

      - name: Check for console.log in frontend
        run: |
          CONSOLE_COUNT=$(git diff origin/${{ github.base_ref }}...HEAD -- frontend/ | grep -E "^\+.*console\.(log|debug|info|warn|error)" | wc -l || true)
          if [ "$CONSOLE_COUNT" -gt 0 ]; then
            echo "::warning::ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‚³ãƒ¼ãƒ‰ã«${CONSOLE_COUNT}å€‹ã®æ–°ã—ã„console.logæ–‡ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ"
          fi

      - name: Check for print statements in backend
        run: |
          PRINT_COUNT=$(git diff origin/${{ github.base_ref }}...HEAD -- backend/ | grep -E "^\+.*print\(" | wc -l || true)
          if [ "$PRINT_COUNT" -gt 0 ]; then
            echo "::warning::ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚³ãƒ¼ãƒ‰ã«${PRINT_COUNT}å€‹ã®æ–°ã—ã„print()æ–‡ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸã€‚é©åˆ‡ãªãƒ­ã‚®ãƒ³ã‚°ã®ä½¿ç”¨ã‚’æ¤œè¨ã—ã¦ãã ã•ã„ã€‚"
          fi

      - name: Check for missing tests
        run: |
          # ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®å¤‰æ›´ã‚’ãƒã‚§ãƒƒã‚¯
          BACKEND_FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD -- backend/app/ | grep -v __pycache__ | wc -l || true)
          BACKEND_TEST_FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD -- backend/tests/ | wc -l || true)

          # ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®å¤‰æ›´ã‚’ãƒã‚§ãƒƒã‚¯
          FRONTEND_FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD -- frontend/src/ | grep -E '\.(ts|vue)$' | wc -l || true)
          FRONTEND_TEST_FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD -- frontend/ | grep -E '\.spec\.(ts|js)$|\.test\.(ts|js)$' | wc -l || true)

          if [ "$BACKEND_FILES" -gt 0 ] && [ "$BACKEND_TEST_FILES" -eq 0 ]; then
            echo "::warning::ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚³ãƒ¼ãƒ‰ãŒå¤‰æ›´ã•ã‚Œã¾ã—ãŸãŒã€ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã¯å¤‰æ›´ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ãƒ†ã‚¹ãƒˆã®è¿½åŠ ã‚’æ¤œè¨ã—ã¦ãã ã•ã„ã€‚"
          fi

          if [ "$FRONTEND_FILES" -gt 0 ] && [ "$FRONTEND_TEST_FILES" -eq 0 ]; then
            echo "::warning::ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‚³ãƒ¼ãƒ‰ãŒå¤‰æ›´ã•ã‚Œã¾ã—ãŸãŒã€ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã¯å¤‰æ›´ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ãƒ†ã‚¹ãƒˆã®è¿½åŠ ã‚’æ¤œè¨ã—ã¦ãã ã•ã„ã€‚"
          fi

      - name: Comment PR with review summary
        uses: actions/github-script@v8
        continue-on-error: true
        if: always()
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('è‡ªå‹•PRãƒ¬ãƒ“ãƒ¥ãƒ¼')
            );

            const body = `## ğŸ¤– è‡ªå‹•PRãƒ¬ãƒ“ãƒ¥ãƒ¼

            âœ… PRã‚¿ã‚¤ãƒˆãƒ«å½¢å¼ãƒã‚§ãƒƒã‚¯å®Œäº†
            âœ… PRã‚µã‚¤ã‚ºåˆ†æå®Œäº†
            âœ… ã‚³ãƒ¼ãƒ‰å“è³ªãƒã‚§ãƒƒã‚¯å®Œäº†

            ä¸Šè¨˜ã®è­¦å‘ŠãŒã‚ã‚‹å ´åˆã¯ã€å¿…è¦ã«å¿œã˜ã¦å¯¾å¿œã—ã¦ãã ã•ã„ã€‚

            *ã“ã‚Œã¯è‡ªå‹•ãƒ¬ãƒ“ãƒ¥ãƒ¼ã§ã™ã€‚äººé–“ã«ã‚ˆã‚‹ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚‚å¿…è¦ã§ã™ã€‚*`;

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }
