# Sprint 03: モバイル対応 + パフォーマンス改善
# 10 Issues / 6 Workers

[mobile-table]
## エージェント定義
あなたは `.claude/agents/parallel-worker-frontend.md` に従って動作するフロントエンドワーカーです。
このファイルを必ず読み、ルールに従うこと。

## タスク
Issue #284: モバイル対応: 統計テーブルのレスポンシブ化

### 目的
統計ページの相性表・マッチアップテーブルがモバイル端末で横スクロールが発生する問題を解決する。

### 実装内容
1. `StatisticsContent.vue` でモバイル判定を追加
2. モバイル時はアコーディオン形式（v-expansion-panels）で表示
   - デッキごとに展開可能なパネル
   - 勝率、勝敗数を見やすく表示
3. デスクトップ時は従来のテーブル表示を維持

### 完了条件
- [ ] モバイル（600px以下）でアコーディオン形式に切り替わる
- [ ] アコーディオンで全データが確認できる
- [ ] デスクトップでは従来表示が維持される
- [ ] テストが追加されている
- [ ] コミットが作成されている（日本語メッセージ）

---

[mobile-form]
## エージェント定義
あなたは `.claude/agents/parallel-worker-frontend.md` に従って動作するフロントエンドワーカーです。
このファイルを必ず読み、ルールに従うこと。

## タスク
Issue #285: モバイル対応: フォーム・レイアウト最適化
Issue #323: fix(shared-stats): スマホUI改善 - 表示順序とランク表記の統一

### 目的
モバイル端末でのフォーム入力とレイアウトを最適化し、共有統計画面のUI改善を行う。

### 実装内容

#### Issue #285
1. `DuelFormDialog.vue`: ラジオボタングループを縦並び対応（`:inline="!isMobile"`）
2. `DashboardView.vue`, `StatisticsView.vue`: padding調整（`pa-4 pa-sm-6`）
3. `DecksView.vue`: ダイアログmax-widthをレスポンシブ化
4. グローバルスタイルでタッチターゲット最小サイズ保証（44px）

#### Issue #323
1. 共有統計画面で「コイン → 先後」の順序に変更
2. ランク表記を統一（M1, D1, P1, G1 等の省略形）

### 完了条件
- [ ] ラジオボタンがモバイルで縦並びになる
- [ ] paddingがモバイルで適切に調整される
- [ ] タッチターゲットが44px以上確保される
- [ ] コイン→先後の順序になっている
- [ ] ランク表記が統一されている
- [ ] テストが追加されている
- [ ] コミットが作成されている（日本語メッセージ）

---

[perf-request]
## エージェント定義
あなたは `.claude/agents/parallel-worker-frontend.md` に従って動作するフロントエンドワーカーです。
このファイルを必ず読み、ルールに従うこと。

## タスク
Issue #307: perf(frontend): 統計画面のリクエスト発火を最適化
Issue #310: perf(request): 連続操作時のリクエストキャンセル機能を実装

### 目的
統計画面のフィルタ変更時の過剰リクエストを防ぎ、連続操作時のリクエストキャンセル機能を実装する。

### 実装内容

#### Issue #307
1. フィルタ変更のdebounce処理（300-500ms）
   - `@vueuse/core` の `useDebounceFn` または `watchDebounced` を活用
2. 複数APIの並列取得（`Promise.all`）
3. キャッシュ済みデータの再取得スキップ

#### Issue #310
1. `useCancellableRequest` composable を作成
   - AbortController によるリクエストキャンセル
   - last-write-wins 設計
2. APIクライアント（api.ts）で AbortSignal サポート
3. 統計画面で連続フィルタ変更時に古いリクエストをキャンセル

### 完了条件
- [ ] フィルタ連続変更時に最後の変更から一定時間後に1回だけリクエスト発火
- [ ] 複数API取得が並列実行される
- [ ] `useCancellableRequest` composable が実装されている
- [ ] 連続変更時に古いリクエストがキャンセルされる
- [ ] テストが追加されている
- [ ] コミットが作成されている（日本語メッセージ）

---

[perf-render]
## エージェント定義
あなたは `.claude/agents/parallel-worker-frontend.md` に従って動作するフロントエンドワーカーです。
このファイルを必ず読み、ルールに従うこと。

## タスク
Issue #309: perf(render): 描画・更新処理の最小化
Issue #306: feat(ux): ローディング表示の分離とユーザー体験の改善

### 目的
不要な再描画を防ぎ、ローディング表示を階層化してUXを改善する。

### 実装内容

#### Issue #309
1. テーマ変更時のデータ再取得防止
   - `watch`や`computed`の依存関係を見直し
2. グラフ・テーブルの差分更新
   - `v-memo`ディレクティブの活用
3. 大量データテーブルの仮想化検討（必要に応じて）

#### Issue #306
1. `useDeferredLoading` composable を作成
   - 300ms未満のリクエストではローディング非表示
   - 遅延表示のしきい値を設定可能
2. 局所ローディングコンポーネント
   - `InlineLoader.vue`: カード内小型ローダー
   - `SkeletonLoader.vue`: スケルトン表示
3. 統計画面でフィルタ/タブ変更時は局所ローディングを使用

### 完了条件
- [ ] テーマ変更時にAPI呼び出しが発生しない
- [ ] `useDeferredLoading` composable が実装されている
- [ ] 局所ローディングコンポーネントが作成されている
- [ ] フィルタ変更時に全画面ローディングが表示されない
- [ ] 300ms未満のリクエストでローディングが表示されない
- [ ] テストが追加されている
- [ ] コミットが作成されている（日本語メッセージ）

---

[perf-polling]
## エージェント定義
あなたは `.claude/agents/parallel-worker-frontend.md` に従って動作するフロントエンドワーカーです。
このファイルを必ず読み、ルールに従うこと。

## タスク
Issue #308: perf(polling): 非表示時のポーリング停止とバックオフ機能の導入

### 目的
OBSオーバーレイや配信者ポップアップのポーリングを最適化し、無駄なAPIリクエストを削減する。

### 実装内容
1. `useSmartPolling` composable を作成
   - `document.visibilityState` 監視で非表示時停止
   - `setInterval` → `setTimeout` 再スケジュール方式に変更
   - エクスポネンシャルバックオフ（エラー時に間隔延長、最大60秒）
2. `OBSOverlayView.vue` に適用
3. `StreamerPopupView.vue` に適用

### インターフェース例
```typescript
const { start, stop, isPolling } = useSmartPolling({
  fn: async () => { /* fetch logic */ },
  interval: 5000,
  maxBackoff: 60000,
  pauseOnHidden: true
})
```

### 完了条件
- [ ] `useSmartPolling` composable が作成されている
- [ ] 非表示時のポーリング停止が実装されている
- [ ] setTimeout 再スケジュール方式に変更されている
- [ ] エラー時のエクスポネンシャルバックオフが実装されている
- [ ] OBSOverlayView, StreamerPopupView に適用されている
- [ ] テストが追加されている
- [ ] コミットが作成されている（日本語メッセージ）

---

[backend-perf]
## エージェント定義
あなたは `.claude/agents/parallel-worker-backend.md` に従って動作するバックエンドワーカーです。
このファイルを必ず読み、ルールに従うこと。

## タスク
Issue #311: perf(api): 統計APIレスポンスの軽量化とキャッシュ対応
Issue #315: テスト強化: 管理API権限・共有統計期限・E2E追加

### 目的
統計APIのレスポンスを軽量化し、管理API・共有統計のテストを強化する。

### 実装内容

#### Issue #311
1. `/statistics/overlay` エンドポイントを追加
   - セッション勝敗、当日勝率のみを返却
   - 軽量なレスポンス
2. `include_duels`, `include_matchup` クエリパラメータを追加
   - デフォルトはTrue、Falseで除外可能
3. ETag / If-None-Match によるキャッシュ検証（可能であれば）

#### Issue #315
1. 管理系APIの権限テスト追加
   - 非認証アクセス拒否（401）
   - 非管理者アクセス拒否（403）
2. 共有統計の期限切れテスト
   - 境界時刻での期限判定
3. 時刻固定テストユーティリティ（freezegun等）

### 完了条件
- [ ] `/statistics/overlay` エンドポイントが実装されている
- [ ] `include_xxx` パラメータが動作する
- [ ] 管理APIの権限テストが追加されている
- [ ] 共有統計の期限切れテストが追加されている
- [ ] テストが全てパスする
- [ ] コミットが作成されている（日本語メッセージ）
